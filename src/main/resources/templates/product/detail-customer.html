<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta charset="UTF-8"/>
    <title th:text="${product.productName}">Product Detail</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <style>
        body { background-color: #f8fafc; font-family: 'Inter', sans-serif; }
        .product-detail-container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .product-card { background: white; border-radius: 12px; padding: 30px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .product-image { width: 100%; max-width: 500px; border-radius: 12px; }
        .price-section { font-size: 2rem; font-weight: 700; color: #dc3545; }
        .original-price { text-decoration: line-through; color: #6c757d; font-size: 1.2rem; }
        .discount-badge { background: #dc3545; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.9rem; }
        .quantity-controls { display: inline-flex; align-items: center; border: 1px solid #ddd; border-radius: 4px; overflow: hidden; }
        .quantity-btn { width: 36px; height: 36px; border: none; background: #f8f9fa; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 500; color: #333; transition: all 0.2s; user-select: none; }
        .quantity-btn:hover:not(:disabled) { background: #e9ecef; color: #000; }
        .quantity-btn:active:not(:disabled) { background: #dee2e6; }
        .quantity-btn:disabled { opacity: 0.5; cursor: not-allowed; background: #f8f9fa; }
        .quantity-input { width: 60px; height: 36px; border: none; border-left: 1px solid #ddd; border-right: 1px solid #ddd; text-align: center; font-size: 16px; font-weight: 500; padding: 0; outline: none; }
        .quantity-input:focus { background: #fff; }
    </style>
</head>
<body>
<!-- Header -->
<div th:replace="~{/Included/Header :: header}"></div>

<div class="product-detail-container">
    <div class="product-card">
        <div class="row">
            <!-- Left: Product Image -->
            <div class="col-md-5">
                <img th:if="${product.image}" 
                     th:src="@{${product.image}}" 
                     class="product-image" 
                     alt="Product Image">
                <div th:unless="${product.image}" class="alert alert-secondary">
                    <p class="mt-2">Chưa có ảnh</p>
                </div>
            </div>

            <!-- Right: Product Info -->
            <div class="col-md-7">
                <h2 th:text="${product.productName}">Product Name</h2>
                
                <!-- Rating (placeholder) -->
                <div class="mb-3">
                    <span class="text-muted">(248 đánh giá)</span>
                </div>

                <!-- Availability -->
                <div class="mb-3">
                    <span th:if="${product.availableStock > 0}" class="badge bg-success">Còn hàng</span>
                    <span th:if="${product.availableStock == 0}" class="badge bg-danger">Hết hàng</span>
                </div>

                <!-- Price -->
                <div class="mb-4">
                    <div class="price-section mb-2">
                        <span th:text="${#numbers.formatDecimal(product.price, 0, 'COMMA', 0, 'POINT')} + ' ₫'">7.990.000 ₫</span>
                    </div>
                    <div class="original-price d-inline-block me-2">
                        <span th:text="${#numbers.formatDecimal(product.price * 1.25, 0, 'COMMA', 0, 'POINT')} + ' ₫'">9.990.000 ₫</span>
                    </div>
                    <span class="discount-badge">-20%</span>
                </div>

                <!-- Quantity Selector -->
                <div class="mb-4" id="quantitySelectorContainer">
                    <label class="form-label fw-bold mb-2">Số lượng:</label>
                    <div class="quantity-controls" id="quantityControls">
                        <button type="button" class="quantity-btn" id="decreaseBtn" onclick="return decreaseQty(event);" title="Giảm số lượng">−</button>
                        <input type="text" id="quantity" class="quantity-input" value="1" inputmode="numeric" pattern="[0-9]*" readonly>
                        <button type="button" class="quantity-btn" id="increaseBtn" onclick="return increaseQty(event);" title="Tăng số lượng">+</button>
                    </div>
                    <small class="text-muted d-block mt-2">Tồn kho: <span id="maxStock" th:text="${product.availableStock}">0</span> sản phẩm</small>
                </div>

                <!-- Action Buttons -->
                <div class="d-flex gap-2 mb-4">
                    <a th:href="@{'/orders/checkout/' + ${product.id} + '?quantity=1'}" 
                       id="buyNowBtn"
                       class="btn btn-primary btn-lg flex-grow-1"
                       th:attr="data-product-id=${product.id}, data-original-href=${'/orders/checkout/' + product.id + '?quantity=1'}"
                       th:if="${product.availableStock > 0 and session.user != null}">
                        Mua ngay
                    </a>
                    <button th:if="${product.availableStock > 0 and session.user == null}" 
                            class="btn btn-primary btn-lg flex-grow-1"
                            onclick="alert('Vui lòng đăng nhập để mua hàng'); window.location.href='/itp/login';">
                        Mua ngay
                    </button>
                    <button th:if="${product.availableStock == 0}" 
                            class="btn btn-secondary btn-lg flex-grow-1" disabled>
                        Hết hàng
                    </button>
                </div>

                <!-- Product Info -->
                <div class="border-top pt-3">
                    <h6 class="fw-bold mb-3">Thông tin sản phẩm</h6>
                    <div class="row g-2 mb-2">
                        <div class="col-4"><strong>Thương hiệu:</strong></div>
                        <div class="col-8" th:text="${product.shop != null ? product.shop.shopName : 'N/A'}">Sony</div>
                    </div>
                    <div class="row g-2 mb-2">
                        <div class="col-4"><strong>Model:</strong></div>
                        <div class="col-8" th:text="${product.productName}">WH-1000XM5</div>
                    </div>
                    <div class="row g-2 mb-2">
                        <div class="col-4"><strong>Kết nối:</strong></div>
                        <div class="col-8">Bluetooth 5.2</div>
                    </div>
                    <div class="row g-2 mb-2">
                        <div class="col-4"><strong>Pin:</strong></div>
                        <div class="col-8">30 giờ</div>
                    </div>
                    <div class="row g-2 mb-2">
                        <div class="col-4"><strong>Bảo hành:</strong></div>
                        <div class="col-8">12 tháng</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Description -->
        <div class="mt-4 border-top pt-4">
            <h5 class="fw-bold mb-3">Mô tả sản phẩm</h5>
            <div th:if="${product.description != null}" th:text="${product.description}">Product description</div>
            <div th:if="${product.detailedDescription != null}" class="mt-3">
                <div th:utext="${product.detailedDescription}">Detailed description</div>
            </div>
            <div th:if="${product.description == null and product.detailedDescription == null}" class="text-muted">
                Chưa có mô tả
            </div>
        </div>
    </div>
</div>

<script>
    const maxStock = /*[[${product.availableStock != null ? product.availableStock : 0}]]*/ 0;
    
    function increaseQty(event) {
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }
        const input = document.getElementById('quantity');
        if (!input) return false;
        const current = parseInt(input.value) || 1;
        if (current < maxStock) {
            input.value = current + 1;
            updateBuyLink();
            updateButtonStates();
        }
        return false;
    }

    function decreaseQty(event) {
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }
        const input = document.getElementById('quantity');
        if (!input) return false;
        const current = parseInt(input.value) || 1;
        if (current > 1) {
            input.value = current - 1;
            updateBuyLink();
            updateButtonStates();
        }
        return false;
    }
    
    function updateButtonStates() {
        const input = document.getElementById('quantity');
        const increaseBtn = document.getElementById('increaseBtn');
        const decreaseBtn = document.getElementById('decreaseBtn');
        if (!input || !increaseBtn || !decreaseBtn) return;
        
        const current = parseInt(input.value) || 1;
        increaseBtn.disabled = current >= maxStock;
        decreaseBtn.disabled = current <= 1;
    }
    
    function updateBuyLink() {
        const quantity = document.getElementById('quantity').value;
        const buyBtn = document.getElementById('buyNowBtn');
        if (buyBtn) {
            // Lấy productId từ href ban đầu hoặc từ data attribute
            let productId = buyBtn.getAttribute('data-product-id');
            if (!productId) {
                // Parse từ href ban đầu: /orders/checkout/{id}?quantity=1
                const originalHref = buyBtn.getAttribute('data-original-href') || buyBtn.href;
                const match = originalHref.match(/\/orders\/checkout\/(\d+)/);
                if (match) {
                    productId = match[1];
                } else {
                    // Fallback: lấy từ Thymeleaf
                    productId = /*[[${product.id != null ? product.id : 0}]]*/ 0;
                }
            }
            // Cập nhật href với quantity mới
            buyBtn.href = `/itp/orders/checkout/${productId}?quantity=${quantity}`;
        }
        console.log('Quantity updated to:', quantity, 'Buy link:', buyBtn ? buyBtn.href : 'N/A');
    }
    
    function validateQuantity(input) {
        let value = parseInt(input.value) || 1;
        if (value > maxStock) {
            value = maxStock;
        } else if (value < 1) {
            value = 1;
        }
        input.value = value;
        updateBuyLink();
    }

    // Ngăn mọi navigation không mong muốn
    document.addEventListener('DOMContentLoaded', function() {
        const quantityInput = document.getElementById('quantity');
        const quantityContainer = document.getElementById('quantitySelectorContainer');
        
        // KHÔNG block events từ buttons - chỉ xử lý input
        // Buttons sẽ hoạt động bình thường với onclick handlers
        
        // Input đã readonly, không cần xử lý events phức tạp
        // Chỉ cần đảm bảo buttons và link hoạt động bình thường
        
        // Không block navigation - cho phép link "Mua ngay" hoạt động bình thường
        
        // Initialize
        const buyBtn = document.getElementById('buyNowBtn');
        if (buyBtn) {
            console.log('Buy button found:', buyBtn);
            console.log('Initial href:', buyBtn.href);
            console.log('Data product-id:', buyBtn.getAttribute('data-product-id'));
            
            // Đảm bảo link không bị block
            buyBtn.addEventListener('click', function(e) {
                console.log('Buy button clicked!');
                console.log('Href:', this.href);
                // Không preventDefault - cho phép navigation
            });
        }
        
        updateBuyLink();
        updateButtonStates();
    });
</script>
</body>
</html>

