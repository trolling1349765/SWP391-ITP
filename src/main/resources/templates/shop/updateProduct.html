<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head th:replace="~{Included/ShopHeader :: shopHead}">
    <link th:href="@{/assets/css/shop/shop-common.css}" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/assets/css/shop/excel-processing.css}">
</head>
<body style="margin:0;padding:0;overflow-x:hidden;">
<div th:replace="~{Included/ShopHeader :: shopHeader}"></div>

<div class="container-fluid p-0">
    <!-- Sidebar Fixed -->
    <div style="position:fixed;top:56px;bottom:0;left:0;width:70px;z-index:1000;">
        <aside th:replace="~{Included/ShopSidebar :: sidebar}"></aside>
    </div>

    <!-- Main Content -->
    <div style="margin-left:85px;padding:1rem;min-height:calc(100vh - 56px);background:#f8f9fa;max-width:calc(100% - 85px);">
        <div class="card">
            <div class="card-header" th:text="'Cập nhật sản phẩm #' + ${productId}">Cập nhật</div>
            <div class="card-body">
                <form th:action="@{'/shop/updateProduct/' + ${productId}}" th:object="${form}" method="post" enctype="multipart/form-data" class="row g-3">

                    <!-- Thông tin cơ bản -->
                    <div class="col-12">
                        <h5 class="border-bottom pb-2 mb-3">Thông tin cơ bản</h5>
                    </div>

                    <div class="col-md-8">
                        <label class="form-label">Tên sản phẩm <span class="text-danger">*</span></label>
                        <input th:field="*{productName}" class="form-control" required/>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Giá <span class="text-danger">*</span></label>
                        <input th:field="*{price}" type="number" min="0" step="0.01" class="form-control" required/>
                    </div>

                    <div class="col-md-6" th:if="${categories != null}">
                        <label class="form-label">Phân loại sản phẩm</label>
                        <select th:field="*{categoryId}" class="form-select" id="categorySelect" onchange="updateProductTypeOptions()">
                            <option value="">-- Chọn phân loại (tùy chọn) --</option>
                            <option th:each="c : ${categories}" 
                                    th:value="${c.id}" 
                                    th:text="${@shopController.getCategoryDisplayName(c.categoryName)}"
                                    th:selected="${c.id == form.categoryId}">Cat</option>
                        </select>
                    </div>
                    <input th:if="${categories == null}" type="hidden" th:field="*{categoryId}"/>

                    <div class="col-md-6">
                        <label class="form-label">Kiểu sản phẩm <span class="text-danger">*</span></label>
                        <select th:field="*{productType}" id="productTypeSelect" class="form-select" required
                                th:attr="data-current-type=${form.productType != null ? form.productType.name() : ''}">
                            <option value="">-- Chọn kiểu sản phẩm --</option>
                            <!-- Options will be populated by JavaScript -->
                        </select>
                    </div>

                    <!-- Mô tả -->
                    <div class="col-12">
                        <h5 class="border-bottom pb-2 mb-3 mt-3">Mô tả sản phẩm</h5>
                    </div>

                    <div class="col-12">
                        <label class="form-label">Mô tả ngắn</label>
                        <textarea th:field="*{description}" rows="2" class="form-control" placeholder="Mô tả ngắn gọn về sản phẩm"></textarea>
                        <small class="text-muted">Hiển thị trong danh sách sản phẩm</small>
                    </div>

                    <div class="col-12">
                        <label class="form-label">Mô tả chi tiết</label>
                        <textarea th:field="*{detailedDescription}" rows="4" class="form-control" placeholder="Mô tả chi tiết về sản phẩm, tính năng, cách sử dụng..."></textarea>
                        <small class="text-muted">Hiển thị trong trang chi tiết sản phẩm</small>
                    </div>

                    <!-- Hình ảnh -->
                    <div class="col-12">
                        <h5 class="border-bottom pb-2 mb-3 mt-3">Hình ảnh sản phẩm</h5>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Ảnh hiện tại</label><br/>
                        <div th:if="${product.image}" class="position-relative d-inline-block">
                            <img th:src="@{${product.image}}" 
                                 alt="current" 
                                 class="img-thumbnail" 
                                 style="max-height:200px; max-width:100%;"
                                 loading="lazy"/>
                        </div>
                        <div th:unless="${product.image}" class="alert alert-secondary">
                            Chưa có ảnh
                        </div>
                        <input type="hidden" th:field="*{img}" th:value="${product.image}"/>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Ảnh mới (tùy chọn)</label>
                        <input type="file" 
                               accept="image/*" 
                               class="form-control"
                               id="imageInput"
                               onchange="uploadNewImage(this)"/>
                        <small class="text-muted">
                            <span id="uploadStatus"></span>
                        </small>
                        
                        <!-- Preview ảnh mới -->
                        <div id="imagePreview" class="mt-3" style="display: none;">
                            <label class="form-label">Ảnh mới:</label><br/>
                            <img id="previewImg" src="" class="img-thumbnail" style="max-height:200px; max-width:100%;"/>
                            <button type="button" class="btn btn-sm btn-danger ms-2" onclick="removeNewImage()">Xóa</button>
                        </div>
                    </div>

                    <!-- Trạng thái & Kho -->
                    <div class="col-12">
                        <h5 class="border-bottom pb-2 mb-3 mt-3">Trạng thái & Kho hàng</h5>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Trạng thái sản phẩm <span class="text-danger">*</span></label>
                        <select name="status" class="form-select" required>
                            <option value="HIDDEN"  th:selected="${product.status.name()=='HIDDEN'}">HIDDEN - Ẩn với khách</option>
                            <option value="ACTIVE"  th:selected="${product.status.name()=='ACTIVE'}">ACTIVE - Hiển thị công khai</option>
                            <option value="BLOCKED" th:selected="${product.status.name()=='BLOCKED'}">BLOCKED - Tạm khóa</option>
                        </select>
                        <small class="text-muted">Chỉ sản phẩm ACTIVE mới hiển thị với khách hàng</small>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Tồn kho hiện tại</label>
                        <div class="input-group">
                            <input th:value="${availableStock}" class="form-control" readonly disabled/>
                            <span class="input-group-text">serials</span>
                        </div>
                        <small class="text-muted text-danger">⚠️ Không thể sửa trực tiếp. Vui lòng quản lý qua trang Kho hàng hoặc upload Excel.</small>
                    </div>

                    <!-- Excel Upload Section -->
                    <div class="col-12">
                        <h5 class="border-bottom pb-2 mb-3 mt-3">Thêm mã sản phẩm từ Excel</h5>
                    </div>

                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">Thông tin sản phẩm</h5>
                            </div>
                            <div class="card-body">
                                <p class="text-muted mb-3">Upload file Excel để thêm mã sản phẩm vào sản phẩm này</p>

                                <div class="mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <label class="form-label mb-0">File Excel chứa mã sản phẩm</label>
                                        <div class="btn-group" role="group">
                                            <a th:href="@{/shop/addProductTemplate}" class="btn btn-outline-primary btn-sm">
                                                Tải Template
                                            </a>
                                            <button type="button" class="btn btn-outline-danger btn-sm"
                                                    onclick="clearFileInput()">
                                                Xóa File
                                            </button>
                                        </div>
                                    </div>
                                    <input name="serialFile" type="file" class="form-control" accept=".xlsx,.xls"
                                           id="serialFileInput" onchange="previewExcelFile(this)"/>
                                    <small class="text-muted">Upload file Excel theo template chuẩn</small>
                                    <div id="fileInfo" class="mt-2"></div>

                                    <!-- Excel Preview Table -->
                                    <div id="excelPreview" class="mt-3" style="display: none;">
                                        <div class="card border-warning">
                                            <div class="card-header bg-warning text-dark">
                                                <h6 class="mb-0">Danh sách các sản phẩm sẽ được thêm vào</h6>
                                            </div>
                                            <div class="card-body p-0">
                                                <div class="table-responsive">
                                                    <table class="table table-striped table-hover mb-0">
                                                        <thead class="table-dark">
                                                        <tr>
                                                            <th>#</th>
                                                            <th>Serial Code</th>
                                                            <th>Secret Code</th>
                                                            <th>Trạng thái</th>
                                                        </tr>
                                                        </thead>
                                                        <tbody id="excelPreviewBody">
                                                        <!-- Dynamic content will be inserted here -->
                                                        </tbody>
                                                    </table>
                                                </div>
                                                <div class="card-footer bg-light">
                                                    <small class="text-muted">
                                                        <i class="fas fa-info-circle"></i>
                                                        Tổng cộng: <span id="totalSerials">0</span> mã sản phẩm sẽ được thêm vào
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="alert alert-info">
                                    <h6>Hướng dẫn tạo file Excel:</h6>
                                    <div class="default-guide">
                                        <ol class="mb-0">
                                            <li><strong>Excel CHỈ CẦN 2 CỘT:</strong> Serial Code và Secret Code</li>
                                            <li>Giá và thông tin sẽ tự động lấy từ sản phẩm</li>
                                            <li>Download template Excel → Upload file → Cập nhật sản phẩm</li>
                                        </ol>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-12">
                        <hr class="my-3"/>
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <a th:href="@{/shop/inventory}" class="btn btn-outline-secondary">Quản lý kho</a>
                            </div>
                            <div>
                                <button class="btn btn-primary" type="submit">Cập nhật</button>
                                <a th:href="@{/shop/dashboard}" class="btn btn-outline-secondary">Hủy</a>
                            </div>
                        </div>
                    </div>

                </form>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script th:src="@{/assets/js/shop/updateProduct.js}"></script>
<script th:src="@{/assets/js/shop/shop-common.js}"></script>
</body>
</html>
