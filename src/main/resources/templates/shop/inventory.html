<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head th:replace="~{Included/ShopHeader :: shopHead}">
    <link th:href="@{/assets/css/shop/shop-common.css}" rel="stylesheet">
</head>
<body style="margin:0;padding-top:56px;overflow-x:hidden;">
<div th:replace="~{Included/ShopHeader :: shopHeader}"></div>

<div class="container-fluid p-0">
    <!-- Sidebar Fixed -->
    <div style="position:fixed;top:56px;bottom:0;left:0;width:70px;z-index:1000;">
        <aside th:replace="~{Included/ShopSidebar :: sidebar}"></aside>
    </div>

    <!-- Main Content -->
    <div style="margin-left:85px;padding:1rem;min-height:calc(100vh - 56px);background:#f8f9fa;max-width:calc(100% - 85px);">

        <!-- Alerts -->
        <div th:if="${ok}" class="alert alert-success" th:text="${ok}"></div>
        <div th:if="${err}" class="alert alert-danger" th:text="${err}"></div>
        
        <!-- Filter Section -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-filter text-primary"></i>
                    Filter & Search
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label class="form-label">Product Type:</label>
                        <select class="form-select" id="productTypeFilter" onchange="filterInventory()">
                            <option value="">All Types</option>
                            <option value="VIETTEL">üì± Th·∫ª Viettel</option>
                            <option value="MOBIFONE">üì± Th·∫ª Mobifone</option>
                            <option value="VINAPHONE">üì± Th·∫ª Vinaphone</option>
                            <option value="VIETTEL_DATA">üì∂ G√≥i data Viettel</option>
                            <option value="MOBIFONE_DATA">üì∂ G√≥i data Mobifone</option>
                            <option value="VINAPHONE_DATA">üì∂ G√≥i data Vinaphone</option>
                            <option value="EMAIL">üí≥ T√†i kho·∫£n Email</option>
                            <option value="GIFT">üéÅ Th·∫ª qu√† t·∫∑ng</option>
                            <option value="SOFTWARE">üîë Key ph·∫ßn m·ªÅm</option>
                            <option value="OTHER">üì¶ Kh√°c</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Face Value:</label>
                        <select class="form-select" id="faceValueFilter" onchange="filterInventory()">
                            <option value="">All Values</option>
                            <option value="10000">10,000 ‚Ç´</option>
                            <option value="20000">20,000 ‚Ç´</option>
                            <option value="50000">50,000 ‚Ç´</option>
                            <option value="100000">100,000 ‚Ç´</option>
                            <option value="200000">200,000 ‚Ç´</option>
                            <option value="500000">500,000 ‚Ç´</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Stock Status:</label>
                        <select class="form-select" id="stockStatusFilter" onchange="filterInventory()">
                            <option value="">All Status</option>
                            <option value="in-stock">In Stock (>10)</option>
                            <option value="low-stock">Low Stock (1-10)</option>
                            <option value="out-of-stock">Out of Stock (0)</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Search:</label>
                        <input type="text" class="form-control" id="searchInput" placeholder="Search product name..." onkeyup="filterInventory()">
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <button class="btn btn-secondary" onclick="clearFilters()">
                            <i class="fas fa-times"></i> Clear Filters
                        </button>
                        <button class="btn btn-primary" onclick="exportFilteredData()">
                            <i class="fas fa-download"></i> Export Filtered
                        </button>
                    </div>
                </div>
            </div>
        </div>
        

        <!-- Inventory Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center border-primary">
                    <div class="card-body">
                        <h5 class="text-primary">T·ªïng s·∫£n ph·∫©m</h5>
                        <h3 class="mb-0" th:text="${products != null ? products.size() : 0}">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-success">
                    <div class="card-body">
                        <h5 class="text-success">ƒêang k√≠ch ho·∫°t</h5>
                        <h3 class="mb-0" th:text="${totalActiveProducts != null ? totalActiveProducts : 0}">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-warning">
                    <div class="card-body">
                        <h5 class="text-warning">S·∫Øp h·∫øt h√†ng</h5>
                        <h3 class="mb-0" th:text="${lowStockProducts != null ? lowStockProducts : 0}">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-danger">
                    <div class="card-body">
                        <h5 class="text-danger">H·∫øt h√†ng</h5>
                        <h3 class="mb-0" th:text="${outOfStockProducts != null ? outOfStockProducts : 0}">0</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- Products & stock table -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>S·∫£n ph·∫©m & T·ªìn kho</span>
                <div class="d-flex gap-2">
                    <a th:href="@{/shop/addProduct}" class="btn btn-primary btn-sm">Th√™m s·∫£n ph·∫©m</a>
                    <a th:href="@{/shop/dashboard}" class="btn btn-outline-secondary btn-sm">Dashboard</a>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-striped align-middle mb-0">
                    <thead>
                    <tr>
                        <th width="60">STT</th>
                        <th>ID</th>
                        <th>T√™n s·∫£n ph·∫©m</th>
                        <th>Gi√°</th>
                        <th>T·ªìn kho</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th class="text-nowrap">Thao t√°c</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="p, iterStat : ${products}" 
                        th:data-product-type="${p.productType.name()}"
                        th:data-face-value="${p.price.intValue()}"
                        th:data-stock="${stockMap[p.id]}"
                        th:data-product-name="${p.productName.toLowerCase()}">
                        <td th:text="${iterStat.index + 1}">1</td>
                        <td th:text="${p.id}">1</td>
                        <td>
                            <strong th:text="${p.productName}">T√™n</strong>
                            <br>
                            <small class="text-muted" th:text="${p.productType.displayName}">Product Type</small>
                        </td>
                        <td th:text="${#numbers.formatDecimal(p.price, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'">0</td>
                        <td>
                            <!-- Total stock with color coding -->
                            <div class="fw-bold">
                                <span th:if="${stockMap[p.id] > 10}" class="badge text-bg-success" th:text="${stockMap[p.id]}">100</span>
                                <span th:if="${stockMap[p.id] > 0 && stockMap[p.id] <= 10}" class="badge text-bg-warning" th:text="${stockMap[p.id]}">5</span>
                                <span th:if="${stockMap[p.id] == 0}" class="badge text-bg-danger" th:text="${stockMap[p.id]}">0</span>
                            </div>
                            <!-- Stock by batches -->
                            <div th:if="${batchMap[p.id] != null && !batchMap[p.id].isEmpty()}" class="small text-muted mt-1">
                                <div th:each="batch : ${batchMap[p.id]}" class="d-flex justify-content-between">
                                    <span th:text="${#numbers.formatDecimal(batch.key, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'">0 ‚Ç´</span>
                                    <span class="badge bg-light text-dark" th:text="${batch.value}">0</span>
                                </div>
                            </div>
                            <div th:if="${batchMap[p.id] == null || batchMap[p.id].isEmpty()}" class="text-muted small">
                                Ch∆∞a c√≥ serial
                            </div>
                        </td>
                        <td>
                            <span class="badge" 
                                  th:classappend="${p.status.name()=='ACTIVE'} ? 'text-bg-success' : 
                                                 (${p.status.name()=='HIDDEN'} ? 'text-bg-secondary' : 'text-bg-danger')"
                                  th:text="${p.status}">HIDDEN</span>
                        </td>
                        <td class="text-nowrap">
                            <div class="btn-group" role="group">
                                <a th:href="@{|/shop/products/${p.id}|}" class="btn btn-sm btn-outline-info">Chi ti·∫øt</a>
                                <a th:href="@{|/shop/updateProduct/${p.id}|}" class="btn btn-sm btn-outline-primary">S·ª≠a</a>
                                <button class="btn btn-sm btn-outline-danger" th:onclick="'deleteProduct(' + ${p.id} + ')'">X√≥a</button>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    function deleteProduct(productId) {
        console.log('deleteProduct called with ID:', productId);
        
        //
        const modalHtml = `
            <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="deleteConfirmModalLabel">X√°c nh·∫≠n x√≥a s·∫£n ph·∫©m</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                        <div class="modal-body">
                            <p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a s·∫£n ph·∫©m #${productId} kh√¥ng?</p>
                            <p class="text-danger"><strong>H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!</strong></p>
                    </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                            <button type="button" class="btn btn-danger" onclick="confirmDelete(${productId})">X√≥a</button>
            </div>
        </div>
    </div>
</div>
        `;
        
        // X√≥a modal c≈© n·∫øu c√≥
        const existingModal = document.getElementById('deleteConfirmModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // Th√™m modal m·ªõi v√†o body
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // Hi·ªÉn th·ªã modal
        const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
        modal.show();
    }
    
    function confirmDelete(productId) {
        console.log('confirmDelete called with ID:', productId);
        
        // G·ª≠i AJAX request ƒë·ªÉ x√≥a s·∫£n ph·∫©m
        fetch(`/itp/shop/products/${productId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            console.log('Response status:', response.status);
            console.log('Response headers:', response.headers);
            
            if (response.ok) {
                return response.json().catch(() => ({})); // Parse JSON if possible, otherwise empty object
            } else {
                return response.text().then(text => {
                    console.log('Error response text:', text);
                    throw new Error(`HTTP ${response.status}: ${text}`);
                });
            }
        })
        .then(data => {
            console.log('Response data:', data);
            
            // ƒê√≥ng modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal'));
            modal.hide();
            
            // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
            showAlert('success', 'ƒê√£ x√≥a s·∫£n ph·∫©m th√†nh c√¥ng!');
            
            // Reload trang sau 1 gi√¢y
            setTimeout(() => {
                location.reload();
            }, 1000);
        })
        .catch(error => {
            console.error('Full error:', error);
            showAlert('danger', 'C√≥ l·ªói x·∫£y ra: ' + error.message);
        });
    }
    
    function showAlert(type, message) {
        const alertHtml = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
        
        // Th√™m alert v√†o ƒë·∫ßu container
        const container = document.querySelector('.col-md-9.col-lg-10');
        container.insertAdjacentHTML('afterbegin', alertHtml);
        
        // T·ª± ƒë·ªông ·∫©n alert sau 5 gi√¢y
        setTimeout(() => {
            const alert = container.querySelector('.alert');
            if (alert) {
                const bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            }
        }, 5000);
    }
    
    // Filtering Functions
    function filterInventory() {
        const productTypeFilter = document.getElementById('productTypeFilter').value;
        const faceValueFilter = document.getElementById('faceValueFilter').value;
        const stockStatusFilter = document.getElementById('stockStatusFilter').value;
        const searchInput = document.getElementById('searchInput').value.toLowerCase();
        
        const rows = document.querySelectorAll('tbody tr');
        let visibleCount = 0;
        
        rows.forEach(row => {
            const productType = row.getAttribute('data-product-type');
            const faceValue = row.getAttribute('data-face-value');
            const stock = parseInt(row.getAttribute('data-stock'));
            const productName = row.getAttribute('data-product-name');
            
            let showRow = true;
            
            // Filter by product type
            if (productTypeFilter && productType !== productTypeFilter) {
                showRow = false;
            }
            
            // Filter by face value
            if (faceValueFilter && faceValue !== faceValueFilter) {
                showRow = false;
            }
            
            // Filter by stock status
            if (stockStatusFilter) {
                if (stockStatusFilter === 'in-stock' && stock <= 10) {
                    showRow = false;
                } else if (stockStatusFilter === 'low-stock' && (stock <= 0 || stock > 10)) {
                    showRow = false;
                } else if (stockStatusFilter === 'out-of-stock' && stock > 0) {
                    showRow = false;
                }
            }
            
            // Filter by search
            if (searchInput && !productName.includes(searchInput)) {
                showRow = false;
            }
            
            if (showRow) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });
        
        // Update counter
        updateVisibleCount(visibleCount, rows.length);
    }
    
    function clearFilters() {
        document.getElementById('productTypeFilter').value = '';
        document.getElementById('faceValueFilter').value = '';
        document.getElementById('stockStatusFilter').value = '';
        document.getElementById('searchInput').value = '';
        
        const rows = document.querySelectorAll('tbody tr');
        rows.forEach(row => {
            row.style.display = '';
        });
        
        updateVisibleCount(rows.length, rows.length);
    }
    
    function updateVisibleCount(visible, total) {
        // Update or create counter element
        let counter = document.getElementById('filterCounter');
        if (!counter) {
            counter = document.createElement('div');
            counter.id = 'filterCounter';
            counter.className = 'alert alert-info';
            document.querySelector('.card-body').appendChild(counter);
        }
        
        if (visible === total) {
            counter.style.display = 'none';
        } else {
            counter.style.display = 'block';
            counter.innerHTML = `<i class="fas fa-info-circle"></i> Showing ${visible} of ${total} products`;
        }
    }
    
    function exportFilteredData() {
        const visibleRows = document.querySelectorAll('tbody tr[style=""]');
        let csvContent = "ID,Product Name,Product Type,Price,Stock,Status\n";
        
        visibleRows.forEach(row => {
            const cells = row.querySelectorAll('td');
            if (cells.length >= 6) {
                const id = cells[1].textContent;
                const name = cells[2].textContent.replace(/\n/g, ' ').trim();
                const price = cells[3].textContent;
                const stock = cells[4].textContent;
                const status = cells[5].textContent;
                
                csvContent += `"${id}","${name}","${price}","${stock}","${status}"\n`;
            }
        });
        
        // Download CSV
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'filtered_inventory_' + new Date().toISOString().split('T')[0] + '.csv';
        a.click();
        window.URL.revokeObjectURL(url);
    }
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        updateVisibleCount(document.querySelectorAll('tbody tr').length, document.querySelectorAll('tbody tr').length);
    });
    
</script>

<script th:src="@{/assets/js/shop/shop-common.js}"></script>

</body>
</html>