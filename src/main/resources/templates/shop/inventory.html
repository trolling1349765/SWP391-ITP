<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head th:replace="~{Included/ShopHeader :: shopHead}">
    <style>
        body { margin:0 !important; padding:0 !important; overflow-x:hidden; }
        .row { margin-left:0 !important; margin-right:0 !important; }
    </style>
</head>
<body style="margin:0;padding:0;overflow-x:hidden;">
<div th:replace="~{Included/ShopHeader :: shopHeader}"></div>

<div class="container-fluid p-0">
    <div class="row g-0">
        <!-- Sidebar -->
        <div class="col-md-3 col-lg-2 p-0" style="position:fixed;top:56px;bottom:0;left:0;z-index:1000;">
            <aside th:replace="~{Included/ShopSidebar :: sidebar}"></aside>
        </div>

        <!-- Main -->
        <div class="col-md-9 col-lg-10 p-3 ms-auto">

        <!-- Alerts -->
        <div th:if="${ok}" class="alert alert-success" th:text="${ok}"></div>
        <div th:if="${err}" class="alert alert-danger" th:text="${err}"></div>

        <!-- Inventory Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center border-primary">
                    <div class="card-body">
                        <h5 class="text-primary">Tổng sản phẩm</h5>
                        <h3 class="mb-0" th:text="${products != null ? products.size() : 0}">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-success">
                    <div class="card-body">
                        <h5 class="text-success">Đang kích hoạt</h5>
                        <h3 class="mb-0" th:text="${totalActiveProducts != null ? totalActiveProducts : 0}">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-warning">
                    <div class="card-body">
                        <h5 class="text-warning">Sắp hết hàng</h5>
                        <h3 class="mb-0" th:text="${lowStockProducts != null ? lowStockProducts : 0}">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-danger">
                    <div class="card-body">
                        <h5 class="text-danger">Hết hàng</h5>
                        <h3 class="mb-0" th:text="${outOfStockProducts != null ? outOfStockProducts : 0}">0</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- Products & stock table -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Sản phẩm & Tồn kho</span>
                <div class="d-flex gap-2">
                    <a th:href="@{/shop/addProduct}" class="btn btn-primary btn-sm">Thêm sản phẩm</a>
                    <a th:href="@{/shop/dashboard}" class="btn btn-outline-secondary btn-sm">Dashboard</a>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-striped align-middle mb-0">
                    <thead>
                    <tr>
                        <th width="60">STT</th>
                        <th>ID</th>
                        <th>Tên sản phẩm</th>
                        <th>Giá</th>
                        <th>Tồn kho</th>
                        <th>Trạng thái</th>
                        <th class="text-nowrap">Thao tác</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="p, iterStat : ${products}">
                        <td th:text="${iterStat.index + 1}">1</td>
                        <td th:text="${p.id}">1</td>
                        <td th:text="${p.productName}">Tên</td>
                        <td th:text="${#numbers.formatDecimal(p.price, 0, 'COMMA', 0, 'POINT')} + ' ₫'">0</td>
                        <td>
                            <span th:if="${stockMap[p.id] > 10}" class="badge text-bg-success" th:text="${stockMap[p.id]}">100</span>
                            <span th:if="${stockMap[p.id] > 0 && stockMap[p.id] <= 10}" class="badge text-bg-warning" th:text="${stockMap[p.id]}">5</span>
                            <span th:if="${stockMap[p.id] == 0}" class="badge text-bg-danger" th:text="${stockMap[p.id]}">0</span>
                        </td>
                        <td>
                            <span class="badge" 
                                  th:classappend="${p.status.name()=='ACTIVE'} ? 'text-bg-success' : 
                                                 (${p.status.name()=='HIDDEN'} ? 'text-bg-secondary' : 'text-bg-danger')"
                                  th:text="${p.status}">HIDDEN</span>
                        </td>
                        <td class="text-nowrap">
                            <div class="btn-group" role="group">
                                <a th:href="@{|/shop/products/${p.id}|}" class="btn btn-sm btn-outline-info">Chi tiết</a>
                                <a th:href="@{|/shop/updateProduct/${p.id}|}" class="btn btn-sm btn-outline-primary">Sửa</a>
                                <button class="btn btn-sm btn-outline-danger" th:onclick="'deleteProduct(' + ${p.id} + ')'">Xóa</button>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    function deleteProduct(productId) {
        console.log('deleteProduct called with ID:', productId);
        
        //
        const modalHtml = `
            <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="deleteConfirmModalLabel">Xác nhận xóa sản phẩm</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p>Bạn có chắc chắn muốn xóa sản phẩm #${productId} không?</p>
                            <p class="text-danger"><strong>Hành động này không thể hoàn tác!</strong></p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                            <button type="button" class="btn btn-danger" onclick="confirmDelete(${productId})">Xóa</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Xóa modal cũ nếu có
        const existingModal = document.getElementById('deleteConfirmModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // Thêm modal mới vào body
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // Hiển thị modal
        const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
        modal.show();
    }
    
    function confirmDelete(productId) {
        console.log('confirmDelete called with ID:', productId);
        
        // Gửi AJAX request để xóa sản phẩm
        fetch(`/itp/shop/products/${productId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            console.log('Response status:', response.status);
            console.log('Response headers:', response.headers);
            
            if (response.ok) {
                return response.json().catch(() => ({})); // Parse JSON if possible, otherwise empty object
            } else {
                return response.text().then(text => {
                    console.log('Error response text:', text);
                    throw new Error(`HTTP ${response.status}: ${text}`);
                });
            }
        })
        .then(data => {
            console.log('Response data:', data);
            
            // Đóng modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal'));
            modal.hide();
            
            // Hiển thị thông báo thành công
            showAlert('success', 'Đã xóa sản phẩm thành công!');
            
            // Reload trang sau 1 giây
            setTimeout(() => {
                location.reload();
            }, 1000);
        })
        .catch(error => {
            console.error('Full error:', error);
            showAlert('danger', 'Có lỗi xảy ra: ' + error.message);
        });
    }
    
    function showAlert(type, message) {
        const alertHtml = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
        
        // Thêm alert vào đầu container
        const container = document.querySelector('.col-md-9.col-lg-10');
        container.insertAdjacentHTML('afterbegin', alertHtml);
        
        // Tự động ẩn alert sau 5 giây
        setTimeout(() => {
            const alert = container.querySelector('.alert');
            if (alert) {
                const bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            }
        }, 5000);
    }
</script>

</body>
</html>