<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head th:replace="~{Included/ShopHeader :: shopHead}">
    <link th:href="@{/assets/css/shop/shop-common.css}" rel="stylesheet">
</head>
<body style="margin:0;padding-top:56px;overflow-x:hidden;">
<div th:replace="~{Included/ShopHeader :: shopHeader}"></div>

<div class="container-fluid p-0">
    <!-- Sidebar Fixed -->
    <div style="position:fixed;top:56px;bottom:0;left:0;width:70px;z-index:1000;">
        <aside th:replace="~{Included/ShopSidebar :: sidebar}"></aside>
    </div>

    <!-- Main Content -->
    <div style="margin-left:85px;padding:1rem;min-height:calc(100vh - 56px);background:#f8f9fa;max-width:calc(100% - 85px);">

        <!-- Alerts -->
        <div th:if="${ok}" class="alert alert-success" th:text="${ok}"></div>
        <div th:if="${err}" class="alert alert-danger" th:text="${err}"></div>
        
        <!-- Filter Section -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-filter text-primary"></i>
                    Filter & Search
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label class="form-label">Category:</label>
                        <select class="form-select" id="categoryFilter" onchange="filterInventory()">
                            <option value="">All Categories</option>
                            <option th:each="cat : ${allCategories}" 
                                    th:value="${cat.id}" 
                                    th:text="${cat.categoryName}">
                                Category Name
                            </option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Face Value:</label>
                        <select class="form-select" id="faceValueFilter" onchange="filterInventory()">
                            <option value="">All Values</option>
                            <option value="10000">10,000 ₫</option>
                            <option value="20000">20,000 ₫</option>
                            <option value="50000">50,000 ₫</option>
                            <option value="100000">100,000 ₫</option>
                            <option value="200000">200,000 ₫</option>
                            <option value="500000">500,000 ₫</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Stock Status:</label>
                        <select class="form-select" id="stockStatusFilter" onchange="filterInventory()">
                            <option value="">All Status</option>
                            <option value="in-stock">In Stock (>10)</option>
                            <option value="low-stock">Low Stock (1-10)</option>
                            <option value="out-of-stock">Out of Stock (0)</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Search:</label>
                        <input type="text" class="form-control" id="searchInput" placeholder="Search product name..." onkeyup="filterInventory()">
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <button class="btn btn-secondary" onclick="clearFilters()">
                            <i class="fas fa-times"></i> Clear Filters
                        </button>
                    </div>
                </div>
            </div>
        </div>
        

        <!-- Inventory Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-2">
                <div class="card text-center border-primary">
                    <div class="card-body">
                        <h5 class="text-primary">Tổng sản phẩm</h5>
                        <h3 class="mb-0" th:text="${products != null ? products.size() : 0}">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card text-center border-success">
                    <div class="card-body">
                        <h5 class="text-success">Đang kích hoạt</h5>
                        <h3 class="mb-0" th:text="${totalActiveProducts != null ? totalActiveProducts : 0}">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card text-center border-warning">
                    <div class="card-body">
                        <h5 class="text-warning">Sắp hết hàng</h5>
                        <h3 class="mb-0" th:text="${lowStockProducts != null ? lowStockProducts : 0}">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card text-center border-danger">
                    <div class="card-body">
                        <h5 class="text-danger">Hết hàng</h5>
                        <h3 class="mb-0" th:text="${outOfStockProducts != null ? outOfStockProducts : 0}">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center border-info" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <div class="card-body">
                        <h5 class="mb-2" style="color: white;">Số dư tài khoản</h5>
                        <h3 class="mb-0 fw-bold" style="color: white;" th:text="${userBalance != null ? #numbers.formatDecimal(userBalance, 0, 'COMMA', 0, 'POINT') + ' ₫' : '0 ₫'}">0 ₫</h3>
                    </div>
                </div>
            </div>
        </div>

       <!-- Products & stock table -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Sản phẩm & Tồn kho</span>
                <div class="d-flex gap-2 align-items-center">
                    <!-- Page size selector -->
                    <div class="d-flex align-items-center gap-2 bg-white px-3 py-2 rounded border shadow-sm">
                        <i class="fas fa-list text-muted"></i>
                        <label class="mb-0 text-muted small fw-bold">Hiển thị:</label>
                        <select class="form-select form-select-sm fw-bold" style="width:70px;border-color:#1abc9c;" 
                                onchange="window.location.href='/itp/shop/inventory?page=1&size=' + this.value">
                            <option value="5" th:selected="${pageSize == 5}">5</option>
                            <option value="10" th:selected="${pageSize == 10}">10</option>
                            <option value="20" th:selected="${pageSize == 20}">20</option>
                            <option value="50" th:selected="${pageSize == 50}">50</option>
                            <option value="100" th:selected="${pageSize == 100}">100</option>
                        </select>
                        <span class="text-muted small">/ trang</span>
                    </div>
                    <a th:href="@{/shop/addProduct}" class="btn btn-primary btn-sm">Thêm sản phẩm</a>
                    <a th:href="@{/shop/dashboard}" class="btn btn-outline-secondary btn-sm">Dashboard</a>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-striped align-middle mb-0">
                    <thead>
                    <tr>
                        <th width="60" class="text-center">STT</th>
                        <th width="100" class="text-center">Ảnh sản phẩm</th>
                        <th>Tên sản phẩm</th>
                        <th>Giá</th>
                        <th class="text-center">Tồn kho</th>
                        <th class="text-center">Trạng thái</th>
                        <th class="text-center">Thao tác</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="p, iterStat : ${products}"
                        th:data-category-id="${p.categoryId}"
                        th:data-face-value="${p.price.intValue()}"
                        th:data-stock="${stockMap[p.id]}"
                        th:data-product-name="${p.productName.toLowerCase()}">
                        <td class="text-center" th:text="${(currentPage - 1) * pageSize + iterStat.index + 1}">1</td>
                        <td class="text-center">
                            <div th:if="${p.image}">
                                <img th:src="@{${p.image}}"
                                     th:attr="data-original-path=${p.image},data-product-id=${p.id}"
                                     class="img-thumbnail" 
                                     style="width:56px;height:56px;object-fit:cover;"
                                     onerror="console.error(' Product #' + this.getAttribute('data-product-id') + ' image failed. DB path:', this.getAttribute('data-original-path'), 'Full URL:', this.src); this.parentElement.innerHTML='<span class=\'badge bg-danger\' title=\'' + this.getAttribute('data-original-path') + '\'>Lỗi ảnh</span>';"
                                     onload="console.log(' Product #' + this.getAttribute('data-product-id') + ' loaded:', this.getAttribute('data-original-path'));"/>
                            </div>
                            <span th:unless="${p.image}" class="badge bg-secondary">Chưa có ảnh</span>
                        </td>
                        <td>
                            <strong th:text="${p.productName}">Tên</strong>
                            <br>
                            <small class="text-muted" th:text="${p.productType.displayName}">Product Type</small>
                        </td>
                        <td th:text="${#numbers.formatDecimal(p.price, 0, 'COMMA', 0, 'POINT')} + ' ₫'">0</td>
                        <td class="text-center">
                            <!-- Total stock with color coding only -->
                            <span th:if="${stockMap[p.id] > 10}" class="badge text-bg-success fs-6" th:text="${stockMap[p.id]}">100</span>
                            <span th:if="${stockMap[p.id] > 0 && stockMap[p.id] <= 10}" class="badge text-bg-warning fs-6" th:text="${stockMap[p.id]}">5</span>
                            <span th:if="${stockMap[p.id] == 0}" class="badge text-bg-danger fs-6" th:text="${stockMap[p.id]}">0</span>
                        </td>
                        <td class="text-center">
                            <span class="badge" 
                                  th:classappend="${p.status.name()=='ACTIVE'} ? 'text-bg-success' : 
                                                 (${p.status.name()=='HIDDEN'} ? 'text-bg-secondary' : 'text-bg-danger')"
                                  th:text="${p.status}">HIDDEN</span>
                        </td>
                        <td class="text-center text-nowrap">
                            <div class="btn-group" role="group">
                                <a th:href="@{|/shop/products/${p.id}|}" class="btn btn-sm btn-outline-info">Chi tiết</a>
                                <a th:href="@{|/shop/updateProduct/${p.id}|}" class="btn btn-sm btn-outline-primary">Sửa</a>
                            </div>
                            <!-- Đổi trạng thái: ACTIVE/HIDDEN/BLOCKED -->
                            <form th:action="@{|/shop/products/${p.id}/status|}" method="post" class="d-inline-flex align-items-center ms-1">
                                <select class="form-select form-select-sm fw-bold" name="status" 
                                        th:style="${p.status.name()=='ACTIVE'} ? 'border-color:#28a745;color:#28a745;' : 
                                                   (${p.status.name()=='HIDDEN'} ? 'border-color:#6c757d;color:#6c757d;' : 'border-color:#dc3545;color:#dc3545;')">
                                    <option value="ACTIVE" th:selected="${p.status.name()=='ACTIVE'}" style="color:#28a745;">✓ ACTIVE</option>
                                    <option value="HIDDEN" th:selected="${p.status.name()=='HIDDEN'}" style="color:#6c757d;">⊝ HIDDEN</option>
                                    <option value="BLOCKED" th:selected="${p.status.name()=='BLOCKED'}" style="color:#dc3545;">✕ BLOCKED</option>
                                </select>
                                <button type="submit" class="btn btn-sm ms-2"
                                        th:classappend="${p.status.name()=='ACTIVE'} ? 'btn-success' : 
                                                         (${p.status.name()=='HIDDEN'} ? 'btn-secondary' : 'btn-danger')">
                                    <i class="fas fa-sync-alt"></i> Đổi
                                </button>
                            </form>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            <div th:if="${totalPages > 1}" class="d-flex justify-content-between align-items-center mt-3 p-3">
                <!-- Pagination info -->
                <div class="text-muted small">
                    Hiển thị <strong th:text="${products.size()}">10</strong> / <strong th:text="${totalProducts}">100</strong> sản phẩm
                </div>

                <!-- Pagination controls -->
                <nav aria-label="Product pagination">
                    <ul class="pagination mb-0">
                        <!-- Previous -->
                        <li class="page-item" th:classappend="${currentPage == 1} ? 'disabled'">
                            <a class="page-link" th:href="@{/shop/inventory(page=${currentPage - 1}, size=${pageSize})}" tabindex="-1">
                                &laquo;
                            </a>
                        </li>

                        <!-- Luôn hiển thị trang 1 -->
                        <li class="page-item" th:classappend="${currentPage == 1} ? 'active'">
                            <a class="page-link" th:href="@{/shop/inventory(page=1, size=${pageSize})}">1</a>
                        </li>

                        <!-- Dấu ... nếu currentPage > 3 -->
                        <li class="page-item disabled" th:if="${currentPage > 3}">
                            <span class="page-link">...</span>
                        </li>

                        <!-- Các trang xung quanh currentPage (giới hạn 2-9) -->
                        <th:block th:if="${totalPages > 2}">
                            <th:block th:each="i : ${#numbers.sequence(2, totalPages - 1)}">
                                <li class="page-item" 
                                    th:if="${i >= currentPage - 1 && i <= currentPage + 1 && i != 1 && i != totalPages}"
                                    th:classappend="${i == currentPage} ? 'active'">
                                    <a class="page-link" th:href="@{/shop/inventory(page=${i}, size=${pageSize})}" th:text="${i}">2</a>
                                </li>
                            </th:block>
                        </th:block>

                        <!-- Dấu ... nếu currentPage < totalPages - 2 -->
                        <li class="page-item disabled" th:if="${currentPage < totalPages - 2 && totalPages > 2}">
                            <span class="page-link">...</span>
                        </li>

                        <!-- Luôn hiển thị trang cuối (nếu totalPages > 1) -->
                        <li class="page-item" th:if="${totalPages > 1}" th:classappend="${currentPage == totalPages} ? 'active'">
                            <a class="page-link" th:href="@{/shop/inventory(page=${totalPages}, size=${pageSize})}" th:text="${totalPages}">10</a>
                        </li>

                        <!-- Next -->
                        <li class="page-item" th:classappend="${currentPage == totalPages} ? 'disabled'">
                            <a class="page-link" th:href="@{/shop/inventory(page=${currentPage + 1}, size=${pageSize})}">
                                &raquo;
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Filtering Functions
    function filterInventory() {
        const categoryFilter = document.getElementById('categoryFilter').value;
        const faceValueFilter = document.getElementById('faceValueFilter').value;
        const stockStatusFilter = document.getElementById('stockStatusFilter').value;
        const searchInput = document.getElementById('searchInput').value.toLowerCase();
        
        const rows = document.querySelectorAll('tbody tr');
        let visibleCount = 0;
        
        rows.forEach(row => {
            const categoryId = row.getAttribute('data-category-id');
            const faceValue = row.getAttribute('data-face-value');
            const stock = parseInt(row.getAttribute('data-stock'));
            const productName = row.getAttribute('data-product-name');
            
            let showRow = true;
            
            // Filter by category
            if (categoryFilter && categoryId !== categoryFilter) {
                showRow = false;
            }
            
            // Filter by face value
            if (faceValueFilter && faceValue !== faceValueFilter) {
                showRow = false;
            }
            
            // Filter by stock status
            if (stockStatusFilter) {
                if (stockStatusFilter === 'in-stock' && stock <= 10) {
                    showRow = false;
                } else if (stockStatusFilter === 'low-stock' && (stock <= 0 || stock > 10)) {
                    showRow = false;
                } else if (stockStatusFilter === 'out-of-stock' && stock > 0) {
                    showRow = false;
                }
            }
            
            // Filter by search
            if (searchInput && !productName.includes(searchInput)) {
                showRow = false;
            }
            
            if (showRow) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });
        
        // Update counter and refresh pagination
        updateVisibleCount(visibleCount, rows.length);
        
        // Refresh pagination after filtering (wait for display updates)
        setTimeout(() => {
            if (typeof refreshPagination === 'function') {
                refreshPagination();
            }
        }, 50);
    }
    
    function clearFilters() {
        document.getElementById('categoryFilter').value = '';
        document.getElementById('faceValueFilter').value = '';
        document.getElementById('stockStatusFilter').value = '';
        document.getElementById('searchInput').value = '';
        
        const rows = document.querySelectorAll('tbody tr');
        rows.forEach(row => {
            row.style.display = '';
        });
        
        updateVisibleCount(rows.length, rows.length);
        
        // Refresh pagination after clearing filters
        setTimeout(() => {
            if (typeof refreshPagination === 'function') {
                refreshPagination();
            }
        }, 50);
    }
    
    function updateVisibleCount(visible, total) {
        // Update or create counter element
        let counter = document.getElementById('filterCounter');
        if (!counter) {
            counter = document.createElement('div');
            counter.id = 'filterCounter';
            counter.className = 'alert alert-info';
            document.querySelector('.card-body').appendChild(counter);
        }
        
        if (visible === total) {
            counter.style.display = 'none';
        } else {
            counter.style.display = 'block';
            counter.innerHTML = `<i class="fas fa-info-circle"></i> Showing ${visible} of ${total} products`;
        }
    }
    
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        updateVisibleCount(document.querySelectorAll('tbody tr').length, document.querySelectorAll('tbody tr').length);
    });
    
</script>

<script th:src="@{/assets/js/inventory-pagination.js}"></script>

</body>
</html>
