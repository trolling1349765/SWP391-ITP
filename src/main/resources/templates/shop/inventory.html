<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head th:replace="~{Included/ShopHeader :: shopHead}">
    <link th:href="@{/assets/css/shop/shop-common.css}" rel="stylesheet">
</head>
<body style="margin:0;padding-top:56px;overflow-x:hidden;">
<div th:replace="~{Included/ShopHeader :: shopHeader}"></div>

<div class="container-fluid p-0">
    <!-- Sidebar Fixed -->
    <div style="position:fixed;top:56px;bottom:0;left:0;width:70px;z-index:1000;">
        <aside th:replace="~{Included/ShopSidebar :: sidebar}"></aside>
    </div>

    <!-- Main Content -->
    <div style="margin-left:85px;padding:1rem;min-height:calc(100vh - 56px);background:#f8f9fa;max-width:calc(100% - 85px);">

        <!-- Alerts -->
        <div th:if="${ok}" class="alert alert-success" th:text="${ok}"></div>
        <div th:if="${err}" class="alert alert-danger" th:text="${err}"></div>
        
        <!-- Filter Section -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-filter text-primary"></i>
                    Filter & Search
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label class="form-label">Category:</label>
                        <select class="form-select" id="categoryFilter" onchange="filterInventory()">
                            <option value="">All Categories</option>
                            <option th:each="cat : ${allCategories}" 
                                    th:value="${cat.id}" 
                                    th:text="${cat.categoryName}">
                                Category Name
                            </option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Face Value:</label>
                        <select class="form-select" id="faceValueFilter" onchange="filterInventory()">
                            <option value="">All Values</option>
                            <option value="10000">10,000 ₫</option>
                            <option value="20000">20,000 ₫</option>
                            <option value="50000">50,000 ₫</option>
                            <option value="100000">100,000 ₫</option>
                            <option value="200000">200,000 ₫</option>
                            <option value="500000">500,000 ₫</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Stock Status:</label>
                        <select class="form-select" id="stockStatusFilter" onchange="filterInventory()">
                            <option value="">All Status</option>
                            <option value="in-stock">In Stock (>10)</option>
                            <option value="low-stock">Low Stock (1-10)</option>
                            <option value="out-of-stock">Out of Stock (0)</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Search:</label>
                        <input type="text" class="form-control" id="searchInput" placeholder="Search product name..." onkeyup="filterInventory()">
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <button class="btn btn-secondary" onclick="clearFilters()">
                            <i class="fas fa-times"></i> Clear Filters
                        </button>
                    </div>
                </div>
            </div>
        </div>
        

        <!-- Inventory Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-2">
                <div class="card text-center border-primary">
                    <div class="card-body">
                        <h5 class="text-primary">Tổng sản phẩm</h5>
                        <h3 class="mb-0" th:text="${products != null ? products.size() : 0}">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card text-center border-success">
                    <div class="card-body">
                        <h5 class="text-success">Đang kích hoạt</h5>
                        <h3 class="mb-0" th:text="${totalActiveProducts != null ? totalActiveProducts : 0}">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card text-center border-warning">
                    <div class="card-body">
                        <h5 class="text-warning">Sắp hết hàng</h5>
                        <h3 class="mb-0" th:text="${lowStockProducts != null ? lowStockProducts : 0}">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card text-center border-danger">
                    <div class="card-body">
                        <h5 class="text-danger">Hết hàng</h5>
                        <h3 class="mb-0" th:text="${outOfStockProducts != null ? outOfStockProducts : 0}">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center border-info" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <div class="card-body">
                        <h5 class="mb-2" style="color: white;">Số dư tài khoản</h5>
                        <h3 class="mb-0 fw-bold" style="color: white;" th:text="${userBalance != null ? #numbers.formatDecimal(userBalance, 0, 'COMMA', 0, 'POINT') + ' ₫' : '0 ₫'}">0 ₫</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- Products & stock table -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Sản phẩm & Tồn kho</span>
                <div class="d-flex gap-2">
                    <a th:href="@{/shop/addProduct}" class="btn btn-primary btn-sm">Thêm sản phẩm</a>
                    <a th:href="@{/shop/dashboard}" class="btn btn-outline-secondary btn-sm">Dashboard</a>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-striped align-middle mb-0">
                    <thead>
                    <tr>
                        <th width="60" class="text-center">STT</th>
                        <th width="100" class="text-center">Ảnh sản phẩm</th>
                        <th>Tên sản phẩm</th>
                        <th>Giá</th>
                        <th class="text-center">Tồn kho</th>
                        <th class="text-center">Trạng thái</th>
                        <th class="text-center">Thao tác</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="p, iterStat : ${products}"
                        th:data-category-id="${p.categoryId}"
                        th:data-face-value="${p.price.intValue()}"
                        th:data-stock="${stockMap[p.id]}"
                        th:data-product-name="${p.productName.toLowerCase()}">
                        <td class="text-center" th:text="${iterStat.index + 1}">1</td>
                        <td class="text-center">
                            <div th:if="${p.image}">
                                <img th:src="@{${p.image}}"
                                     th:attr="data-original-path=${p.image},data-product-id=${p.id}"
                                     class="img-thumbnail" 
                                     style="width:56px;height:56px;object-fit:cover;"
                                     onerror="console.error(' Product #' + this.getAttribute('data-product-id') + ' image failed. DB path:', this.getAttribute('data-original-path'), 'Full URL:', this.src); this.parentElement.innerHTML='<span class=\'badge bg-danger\' title=\'' + this.getAttribute('data-original-path') + '\'>Lỗi ảnh</span>';"
                                     onload="console.log(' Product #' + this.getAttribute('data-product-id') + ' loaded:', this.getAttribute('data-original-path'));"/>
                            </div>
                            <span th:unless="${p.image}" class="badge bg-secondary">Chưa có ảnh</span>
                        </td>
                        <td>
                            <strong th:text="${p.productName}">Tên</strong>
                            <br>
                            <small class="text-muted" th:text="${p.productType.displayName}">Product Type</small>
                        </td>
                        <td th:text="${#numbers.formatDecimal(p.price, 0, 'COMMA', 0, 'POINT')} + ' ₫'">0</td>
                        <td class="text-center">
                            <!-- Total stock with color coding only -->
                            <span th:if="${stockMap[p.id] > 10}" class="badge text-bg-success fs-6" th:text="${stockMap[p.id]}">100</span>
                            <span th:if="${stockMap[p.id] > 0 && stockMap[p.id] <= 10}" class="badge text-bg-warning fs-6" th:text="${stockMap[p.id]}">5</span>
                            <span th:if="${stockMap[p.id] == 0}" class="badge text-bg-danger fs-6" th:text="${stockMap[p.id]}">0</span>
                        </td>
                        <td class="text-center">
                            <span class="badge" 
                                  th:classappend="${p.status.name()=='ACTIVE'} ? 'text-bg-success' : 
                                                 (${p.status.name()=='HIDDEN'} ? 'text-bg-secondary' : 'text-bg-danger')"
                                  th:text="${p.status}">HIDDEN</span>
                        </td>
                        <td class="text-center text-nowrap">
                            <div class="btn-group" role="group">
                                <a th:href="@{|/shop/products/${p.id}|}" class="btn btn-sm btn-outline-info">Chi tiết</a>
                                <a th:href="@{|/shop/updateProduct/${p.id}|}" class="btn btn-sm btn-outline-primary">Sửa</a>
                                <button class="btn btn-sm btn-outline-danger delete-product-btn" th:data-product-id="${p.id}">Xóa</button>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <!-- Pagination will be inserted here by JavaScript -->
        </div>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    function deleteProduct(productId) {
        if (typeof bootstrap === 'undefined') {
            alert('Lỗi: Bootstrap chưa được tải. Vui lòng reload trang.');
            return;
        }
        
        const modalHtml = `
            <div class="modal fade" id="deleteConfirmModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header bg-danger text-white">
                            <h5 class="modal-title">Xác nhận xóa sản phẩm</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <p>Bạn có chắc chắn muốn xóa sản phẩm <strong>#${productId}</strong> không?</p>
                            <p class="text-danger mb-0"><strong>Hành động này không thể hoàn tác!</strong></p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                            <button type="button" class="btn btn-danger" onclick="confirmDelete(${productId})">Xóa</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        const existingModal = document.getElementById('deleteConfirmModal');
        if (existingModal) existingModal.remove();
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
        modal.show();
    }
    
    function confirmDelete(productId) {
        const modalElement = document.getElementById('deleteConfirmModal');
        const modal = bootstrap.Modal.getInstance(modalElement);
        if (modal) modal.hide();
        
        showAlert('info', 'Đang xóa sản phẩm...');
        
        fetch(`/itp/shop/products/${productId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (response.ok || response.status === 200) {
                return response.json().catch(() => ({ success: true }));
            } else {
                throw new Error(`Server trả về lỗi ${response.status}`);
            }
        })
        .then(() => {
            showAlert('success', 'Đã xóa sản phẩm thành công!');
            setTimeout(() => location.reload(), 1000);
        })
        .catch(error => {
            showAlert('danger', 'Lỗi: ' + error.message);
        });
    }
    
    function showAlert(type, message) {
        // Remove existing alerts
        const existingAlerts = document.querySelectorAll('.alert.custom-alert');
        existingAlerts.forEach(alert => alert.remove());
        
        // Create alert element
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show custom-alert`;
        alertDiv.setAttribute('role', 'alert');
        alertDiv.style.cssText = `
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 99999;
            min-width: 400px;
            max-width: 600px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            font-size: 16px;
            font-weight: 500;
        `;
        
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(alertDiv);
        
        // Auto remove after 3 seconds
        setTimeout(() => {
            if (alertDiv && alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 3000);
    }
    
    // Filtering Functions
    function filterInventory() {
        const categoryFilter = document.getElementById('categoryFilter').value;
        const faceValueFilter = document.getElementById('faceValueFilter').value;
        const stockStatusFilter = document.getElementById('stockStatusFilter').value;
        const searchInput = document.getElementById('searchInput').value.toLowerCase();
        
        const rows = document.querySelectorAll('tbody tr');
        let visibleCount = 0;
        
        rows.forEach(row => {
            const categoryId = row.getAttribute('data-category-id');
            const faceValue = row.getAttribute('data-face-value');
            const stock = parseInt(row.getAttribute('data-stock'));
            const productName = row.getAttribute('data-product-name');
            
            let showRow = true;
            
            // Filter by category
            if (categoryFilter && categoryId !== categoryFilter) {
                showRow = false;
            }
            
            // Filter by face value
            if (faceValueFilter && faceValue !== faceValueFilter) {
                showRow = false;
            }
            
            // Filter by stock status
            if (stockStatusFilter) {
                if (stockStatusFilter === 'in-stock' && stock <= 10) {
                    showRow = false;
                } else if (stockStatusFilter === 'low-stock' && (stock <= 0 || stock > 10)) {
                    showRow = false;
                } else if (stockStatusFilter === 'out-of-stock' && stock > 0) {
                    showRow = false;
                }
            }
            
            // Filter by search
            if (searchInput && !productName.includes(searchInput)) {
                showRow = false;
            }
            
            if (showRow) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });
        
        // Update counter and refresh pagination
        updateVisibleCount(visibleCount, rows.length);
        
        // Refresh pagination after filtering (wait for display updates)
        setTimeout(() => {
            if (typeof refreshPagination === 'function') {
                refreshPagination();
            }
        }, 50);
    }
    
    function clearFilters() {
        document.getElementById('categoryFilter').value = '';
        document.getElementById('faceValueFilter').value = '';
        document.getElementById('stockStatusFilter').value = '';
        document.getElementById('searchInput').value = '';
        
        const rows = document.querySelectorAll('tbody tr');
        rows.forEach(row => {
            row.style.display = '';
        });
        
        updateVisibleCount(rows.length, rows.length);
        
        // Refresh pagination after clearing filters
        setTimeout(() => {
            if (typeof refreshPagination === 'function') {
                refreshPagination();
            }
        }, 50);
    }
    
    function updateVisibleCount(visible, total) {
        // Update or create counter element
        let counter = document.getElementById('filterCounter');
        if (!counter) {
            counter = document.createElement('div');
            counter.id = 'filterCounter';
            counter.className = 'alert alert-info';
            document.querySelector('.card-body').appendChild(counter);
        }
        
        if (visible === total) {
            counter.style.display = 'none';
        } else {
            counter.style.display = 'block';
            counter.innerHTML = `<i class="fas fa-info-circle"></i> Showing ${visible} of ${total} products`;
        }
    }
    
    
    // Function to attach delete button listeners
    function attachDeleteListeners() {
        document.querySelectorAll('.delete-product-btn').forEach(btn => {
            btn.removeEventListener('click', handleDelete); // Remove old listener
            btn.addEventListener('click', handleDelete);
        });
    }
    
    function handleDelete(event) {
        const productId = this.getAttribute('data-product-id');
        deleteProduct(productId);
    }
    
    // Make it global so pagination can call it
    window.attachDeleteListeners = attachDeleteListeners;
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        updateVisibleCount(document.querySelectorAll('tbody tr').length, document.querySelectorAll('tbody tr').length);
        attachDeleteListeners();
    });
    
</script>

<script th:src="@{/assets/js/inventory-pagination.js}"></script>

</body>
</html>