<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="'Shop Details - ' + ${shop.shopName}">Shop Details</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" th:href="@{/css/shop-detail.css}">

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>

<div class="shop-detail-container">
    <!-- === BACK BUTTON === -->
    <div class="mb-3">
        <a th:href="@{/admin/registers}" class="btn btn-outline-secondary me-2">
            ← Back to Shop Register
        </a>
        <a th:href="@{/admin/shops}" class="btn btn-outline-secondary">
            ← Back to Manage Shops
        </a>
    </div>
    
    <!-- === SHOP HEADER === -->
    <div class="shop-header-card">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-4">
            <div class="d-flex align-items-center gap-4">
                <!-- Shop Logo/Avatar -->
                <div class="shop-avatar">
                    <img th:if="${shop.imageUrl != null && shop.imageUrl != ''}" 
                         th:src="${shop.imageUrl.startsWith('/') ? '/itp' + shop.imageUrl : '/itp/' + shop.imageUrl}" 
                         alt="Shop Logo"
                         th:attr="data-image-path=${shop.imageUrl}"
                         onerror="console.error('Failed to load shop logo:', this.getAttribute('data-image-path'), 'Full URL:', this.src); this.style.display='none'; this.nextElementSibling.style.display='flex';"
                         onload="console.log('Shop logo loaded:', this.getAttribute('data-image-path'));">
                    <div th:unless="${shop.imageUrl != null && shop.imageUrl != ''}" 
                         style="display: flex; width: 100%; height: 100%; align-items: center; justify-content: center;">
                        SHOP
                    </div>
                </div>

                <!-- Shop Info -->
                <div class="shop-info">
                    <h3 th:text="${shop.shopName}">Shop Name</h3>
                    <p class="meta mb-2">
                        <span th:text="${shop.category}">Category</span> | 
                        <span th:text="'ID: ' + ${shop.shopCode}">ID: SH001</span>
                    </p>
                    <span class="status-badge" 
                          th:classappend="${shop.status == 'ACTIVE' or shop.status == 'active'} ? 'active' : 'inactive'"
                          th:text="${#strings.capitalize(shop.status)}">Active</span>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="action-buttons">
                <!-- Admin: Active button for inactive shops -->
                <span th:if="${!shop.isDeleted
                   and shop.status.equalsIgnoreCase('INACTIVE')
                   and session.user != null
                   and session.role == 'ADMIN'
                   }">
                    <a th:href="@{'/admin/registers/activate/' + ${shop.id}}" class="btn btn-success">
                        Accept
                    </a>
                    <a th:href="@{/admin/registers}" class="btn btn-primary">
                        Back
                    </a>
                    <!-- Reject (soft delete only) -->
                    <form th:action="@{/admin/registers/delete/{id}(id=${shop.id})}" method="post" 
                          onsubmit="return confirm('Bạn có chắc chắn muốn từ chối shop này? Shop sẽ bị từ chối nhưng user vẫn chưa thể đăng ký lại. Bạn có thể unlock sau.');" 
                          style="display: inline;">
                        <input type="hidden" name="_method" value="delete">
                        <button type="submit" class="btn btn-danger">
                            Reject
                        </button>
                    </form>
                    <!-- Reject & Unlock (reject và unlock luôn) -->
                    <form th:action="@{/admin/registers/rejectAndUnlock/{id}(id=${shop.id})}" method="post" 
                          onsubmit="return confirm('Bạn có chắc chắn muốn từ chối shop này và unlock user? User sẽ có thể đăng ký shop mới ngay. Shop cũ vẫn được giữ lại làm bằng chứng.');" 
                          style="display: inline;">
                        <button type="submit" class="btn btn-warning">
                            Reject & Lock User
                        </button>
                    </form>
                </span>
                
                <!-- Admin: Allow Re-registration button for deleted shops -->
                <span th:if="${shop.isDeleted != null and shop.isDeleted
                   and session.user != null
                   and session.role == 'ADMIN'
                   }">
                    <form th:action="@{/admin/shops/allowReRegistration/{id}(id=${shop.id})}" method="post" 
                          onsubmit="return confirm('Bạn có chắc chắn muốn mở khóa user này? User sẽ có thể đăng ký shop mới. Shop cũ vẫn được giữ lại làm bằng chứng.');" 
                          style="display: inline;">
                        <button type="submit" class="btn btn-warning">
                            Allow Re-registration
                        </button>
                    </form>
                    <a th:href="@{/admin/shops}" class="btn btn-primary">
                        Back
                    </a>
                </span>
                
                <!-- Seller: Edit and View Store buttons for active shops -->
                <span th:if="${!shop.isDeleted
                   and shop.status.equalsIgnoreCase('ACTIVE')
                   and session.user != null
                   and session.role == 'SELLER'
                   }">
                    <a href="#" class="btn btn-primary">
                        Edit
                    </a>
                    <a href="#" class="btn btn-outline-secondary">
                        View Store
                    </a>
                </span>
            </div>
        </div>
    </div>

    <!-- === SUMMARY CARDS === -->
    <div class="row g-4 mb-4">
        <div class="col-md-3 col-sm-6">
            <div class="summary-card">
                <h2 class="text-primary" th:text="${totalProducts != null ? totalProducts : 0}">0</h2>
                <p>Total Products</p>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="summary-card">
                <h2 class="text-success" th:text="${inStock != null ? inStock : 0}">0</h2>
                <p>In Stock</p>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="summary-card">
                <h2 class="text-warning" th:text="${lowStock != null ? lowStock : 0}">0</h2>
                <p>Low Stock</p>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="summary-card">
                <h2 class="text-danger" th:text="${outOfStock != null ? outOfStock : 0}">0</h2>
                <p>Out of Stock</p>
            </div>
        </div>
    </div>

    <!-- === BASIC INFORMATION === -->
    <div class="info-card">
        <div class="info-card-header">
            Basic Information
        </div>
        <div class="info-card-body">
            <div class="row g-4">
                <div class="col-md-6">
                    <label class="form-label">Shop Name</label>
                    <input type="text" class="form-control" th:value="${shop.shopName}" readonly>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Shop Code</label>
                    <input type="text" class="form-control" th:value="${shop.shopCode}" readonly>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Categories</label>
                    <input type="text" class="form-control" th:value="${shop.category}" readonly>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Status</label>
                    <input type="text" class="form-control" 
                           th:value="${#strings.capitalize(shop.status)}" readonly>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Owner (Username)</label>
                    <input type="text" class="form-control" 
                           th:value="${shop.user != null ? shop.user.username : 'N/A'}" readonly>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Created At</label>
                    <input type="text" class="form-control" 
                           th:value="${shop.createAt != null ? #temporals.format(shop.createAt, 'dd/MM/yyyy') : 'N/A'}" readonly>
                </div>
                <div class="col-12">
                    <label class="form-label">Short Description</label>
                    <textarea class="form-control" rows="2" th:text="${shop.shortDescription}" readonly></textarea>
                </div>
                <div class="col-12">
                    <label class="form-label">Detailed Description</label>
                    <textarea class="form-control" rows="5" th:text="${shop.description}" readonly></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- === CONTACT INFORMATION === -->
    <div class="info-card">
        <div class="info-card-header">
            Contact Information
        </div>
        <div class="info-card-body">
            <div class="row g-4">
                <div class="col-md-6">
                    <label class="form-label">Phone</label>
                    <input type="text" class="form-control" th:value="${shop.phone}" readonly>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Email</label>
                    <input type="text" class="form-control" th:value="${shop.email}" readonly>
                </div>
                <div class="col-12">
                    <label class="form-label">Facebook Link</label>
                    <input type="text" class="form-control" th:value="${shop.facebookLink}" readonly>
                    <small class="text-muted mt-2 d-block" th:if="${shop.facebookLink != null && !shop.facebookLink.isEmpty()}">
                        <a th:href="${shop.facebookLink}" target="_blank" class="text-decoration-none">
                            Visit Facebook Page
                        </a>
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- === SHOP BANNER === -->
    <div class="info-card" th:if="${shop.image != null && shop.image != ''}">
        <div class="info-card-header">
            Shop Banner
        </div>
        <div class="info-card-body text-center">
            <img th:src="${shop.image.startsWith('/') ? '/itp' + shop.image : '/itp/' + shop.image}" 
                 alt="Shop Banner" 
                 class="img-fluid rounded banner-image"
                 th:attr="data-image-path=${shop.image}"
                 onerror="console.error('Failed to load shop banner:', this.getAttribute('data-image-path'), 'Full URL:', this.src); this.style.display='none';"
                 onload="console.log('Shop banner loaded:', this.getAttribute('data-image-path'));">
        </div>
    </div>

    <!-- === PRODUCTS === -->
    <div class="info-card" th:if="${shop.products != null && !shop.products.isEmpty()}">
        <div class="info-card-header">
            Products (<span th:text="${shop.products.size()}">0</span>)
        </div>
        <div class="info-card-body">
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-4">
                <div th:each="product : ${shop.products}" class="col">
                    <div class="product-card">
                        <img th:if="${product.image != null && product.image != ''}"
                             th:src="@{'/itp' + ${product.image}}"
                             alt="Product image"
                             onerror="this.src='/itp/assets/img/default-product.jpg';">
                        <div th:unless="${product.image != null && product.image != ''}"
                             class="product-placeholder">
                            No Image
                        </div>
                        <div class="product-card-body">
                            <h5 class="card-title mb-2" th:text="${product.productName}">Product Name</h5>
                            <p class="text-primary mb-2 fw-bold" th:text="${#numbers.formatDecimal(product.price, 0, 'COMMA', 0, 'POINT')} + ' ₫'">0 ₫</p>
                            <small class="text-secondary" th:text="${product.status}">Status</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

</body>
</html>
