<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head th:replace="~{Included/ShopHeader :: shopHead}"></head>
<body style="margin:0;padding-top:56px;overflow-x:hidden;">
<div th:replace="~{Included/ShopHeader :: shopHeader}"></div>

<div class="container-fluid p-0">
    <div class="row g-0">
        <div class="col-md-3 col-lg-2 p-0" style="position:fixed;top:56px;bottom:0;left:0;z-index:1000;">
            <aside th:replace="~{Included/ShopSidebar :: sidebar}"></aside>
        </div>

        <div class="col-md-9 col-lg-10 p-3 ms-auto">
        <div class="d-flex align-items-center justify-content-between mb-3">
            <h4 class="mb-0">Thêm sản phẩm</h4>
            <a th:href="@{/shop/dashboard}" class="btn btn-outline-secondary btn-sm">← Dashboard</a>
        </div>

        <form th:action="@{/shop/addProduct}" th:object="${form}" method="post" enctype="multipart/form-data" class="row g-3">

                    <div class="col-md-8">
                        <label class="form-label">Tên sản phẩm</label>
                        <input th:field="*{productName}" class="form-control" placeholder="Nhập tên..." required/>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Giá <span class="text-danger">*</span></label>
                        <input th:field="*{price}" id="priceInput" type="number" min="0" step="0.01" class="form-control" placeholder="0.00" required/>
                        <small class="text-muted">Giá này sẽ được tự động điền khi chọn mệnh giá</small>
                    </div>

                    <div class="col-md-6" th:if="${categories != null}">
                        <label class="form-label">Phân loại sản phẩm</label>
                        <select th:field="*{categoryId}" class="form-select">
                            <option value="">-- Chọn phân loại (tùy chọn) --</option>
                            <option th:each="c : ${categories}" th:value="${c.id}" th:text="${@shopController.getCategoryDisplayName(c.categoryName)}">Cat</option>
                        </select>
                    </div>
                    <input th:if="${categories == null}" type="hidden" th:field="*{categoryId}"/>

                    <div class="col-md-6">
                        <label class="form-label">Kiểu sản phẩm <span class="text-danger">*</span></label>
                        <select th:field="*{productType}" id="productTypeSelect" class="form-select" required onchange="updateProductTypeGuide()">
                            <option value="">-- Chọn kiểu sản phẩm --</option>
                            <!-- Options will be populated dynamically based on category selection -->
                        </select>
                    </div>

                    <div class="col-md-6" id="faceValueSection" style="display: none;">
                        <label class="form-label">Mệnh giá <span class="text-danger">*</span></label>
                        <select id="faceValueSelect" name="faceValue" class="form-select" onchange="updatePriceFromFaceValue()">
                            <option value="">-- Chọn mệnh giá --</option>
                            <option value="10000">10,000 ₫</option>
                            <option value="20000">20,000 ₫</option>
                            <option value="50000">50,000 ₫</option>
                            <option value="100000">100,000 ₫</option>
                            <option value="200000">200,000 ₫</option>
                            <option value="500000">500,000 ₫</option>
                            <option value="custom">Tùy chỉnh</option>
                        </select>
                    </div>

                    <div class="col-md-12">
                        <label class="form-label">Mô tả ngắn</label>
                        <textarea th:field="*{description}" class="form-control" rows="2" placeholder="Mô tả ngắn gọn về sản phẩm"></textarea>
                    </div>

                    <div class="col-md-12">
                        <label class="form-label">Mô tả chi tiết</label>
                        <textarea th:field="*{detailedDescription}" class="form-control" rows="4" placeholder="Mô tả chi tiết về sản phẩm, tính năng, cách sử dụng..."></textarea>
                    </div>

                    <div class="col-md-12">
                        <label class="form-label">Ảnh (tùy chọn)</label>
                        <input th:field="*{file}" type="file" class="form-control" accept="image/*"/>
                        <small class="text-muted">Chọn file ảnh để upload</small>
                    </div>

                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">Thông tin Serial & Số lượng</h5>
                            </div>
                            <div class="card-body">
                                <p class="text-muted mb-3">Bắt buộc upload file Excel để nhập serial và số lượng</p>
                                
                                <div class="mb-3">
                                    <label class="form-label">File Excel chứa Serial & Số lượng</label>
                                    <input th:field="*{serialFile}" type="file" class="form-control" accept=".xlsx,.xls" required/>
                                    <small class="text-muted">Upload file Excel theo template chuẩn</small>
                                </div>

                                <div class="alert alert-info">
                                    <h6>Hướng dẫn tạo file Excel:</h6>
                                    <div class="phone-card-guide" style="display: none;">
                                        <strong>Thẻ điện thoại:</strong>
                                        <ul class="mb-0">
                                            <li><strong>Serial Code:</strong> Mã thẻ điện thoại (VD: 1234567890123456)</li>
                                            <li><strong>Secret Code:</strong> Mã PIN thẻ (VD: ABCD1234)</li>
                                            <li><strong>Face Value:</strong> Mệnh giá thẻ (VD: 10000)</li>
                                            <li><strong>Information:</strong> Thông tin bổ sung (VD: Thẻ Viettel 10K)</li>
                                        </ul>
                                    </div>
                                    
                                    <div class="email-account-guide" style="display: none;">
                                        <strong>Tài khoản email:</strong>
                                        <ul class="mb-0">
                                            <li><strong>Serial Code:</strong> Email address (VD: user123@gmail.com)</li>
                                            <li><strong>Secret Code:</strong> Password (VD: password123)</li>
                                            <li><strong>Face Value:</strong> Giá bán tài khoản (có thể tùy chỉnh)</li>
                                            <li><strong>Information:</strong> Thông tin bổ sung (đã verify, chưa verify, etc.)</li>
                                        </ul>
                                    </div>
                                    
                                    <div class="gift-card-guide" style="display: none;">
                                        <strong>Thẻ quà tặng:</strong>
                                        <ul class="mb-0">
                                            <li><strong>Serial Code:</strong> Mã thẻ quà tặng</li>
                                            <li><strong>Secret Code:</strong> Pin code (nếu có)</li>
                                            <li><strong>Face Value:</strong> Mệnh giá thẻ</li>
                                            <li><strong>Information:</strong> Loại thẻ, hạn sử dụng</li>
                                        </ul>
                                    </div>
                                    
                                    <div class="software-key-guide" style="display: none;">
                                        <strong>Key phần mềm:</strong>
                                        <ul class="mb-0">
                                            <li><strong>Serial Code:</strong> License key (VD: XXXXX-XXXXX-XXXXX)</li>
                                            <li><strong>Secret Code:</strong> Activation code (nếu có)</li>
                                            <li><strong>Face Value:</strong> Giá bán key</li>
                                            <li><strong>Information:</strong> Tên phần mềm, phiên bản</li>
                                        </ul>
                                    </div>
                                    <div class="default-guide">
                                        <ol class="mb-0">
                                            <li>Chọn kiểu sản phẩm để xem hướng dẫn chi tiết</li>
                                            <li>Download template Excel chuẩn</li>
                                            <li>Upload file Excel để hệ thống tự động đếm số lượng</li>
                                        </ol>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-12">
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">Tạo sản phẩm</button>
                            <a th:href="@{/shop/dashboard}" class="btn btn-secondary">Hủy</a>
                        </div>
                    </div>
                </form>
        </div>
    </div>
</div>

<script>
    // Handle product type selection
    function updateProductTypeGuide() {
        const productType = document.querySelector('select[name="productType"]').value;
        const faceValueSection = document.getElementById('faceValueSection');
        const faceValueSelect = document.getElementById('faceValueSelect');
        const priceInput = document.getElementById('priceInput');
        
        // Hide all guides first
        document.querySelectorAll('.phone-card-guide, .email-account-guide, .gift-card-guide, .software-key-guide, .default-guide').forEach(guide => {
            guide.style.display = 'none';
        });
        
        // Show face value section only for telecom cards
        const telecomCards = ['VIETTEL', 'MOBIFONE', 'VINAPHONE', 'VIETTEL_DATA', 'MOBIFONE_DATA', 'VINAPHONE_DATA'];
        if (telecomCards.includes(productType)) {
            faceValueSection.style.display = 'block';
        } else {
            faceValueSection.style.display = 'none';
            // Reset face value and price when not telecom card
            faceValueSelect.value = '';
            priceInput.value = '';
        }
        
        // Show appropriate guide based on product type
        if (telecomCards.includes(productType)) {
            document.querySelector('.phone-card-guide').style.display = 'block';
        } else if (['EMAIL', 'SOCIAL', 'STREAMING', 'APP'].includes(productType)) {
            document.querySelector('.email-account-guide').style.display = 'block';
        } else if (['GIFT', 'VOUCHER', 'COUPON', 'PROMO'].includes(productType)) {
            document.querySelector('.gift-card-guide').style.display = 'block';
        } else if (['SOFTWARE', 'LICENSE', 'ACTIVATION', 'SUBSCRIPTION'].includes(productType)) {
            document.querySelector('.software-key-guide').style.display = 'block';
        } else {
            document.querySelector('.default-guide').style.display = 'block';
        }
    }
    
    // Handle face value selection
    function updatePriceFromFaceValue() {
        const faceValueSelect = document.getElementById('faceValueSelect');
        const priceInput = document.getElementById('priceInput');
        
        if (faceValueSelect.value && faceValueSelect.value !== 'custom') {
            // Auto-fill price with face value
            priceInput.value = faceValueSelect.value;
        } else if (faceValueSelect.value === 'custom') {
            // Allow custom input
            const customValue = prompt('Nhập mệnh giá tùy chỉnh:');
            if (customValue && !isNaN(customValue)) {
                faceValueSelect.value = customValue;
                priceInput.value = customValue;
            } else {
                faceValueSelect.value = '';
            }
        }
    }
    
    // Category to ProductType mapping (Categories in English, ProductTypes in Vietnamese)
    const categoryProductTypeMap = {
        // TELECOM (Viễn thông)
        'TELECOM': [
            { value: 'VIETTEL', text: 'Thẻ Viettel' },
            { value: 'MOBIFONE', text: 'Thẻ Mobifone' },
            { value: 'VINAPHONE', text: 'Thẻ Vinaphone' },
            { value: 'VIETTEL_DATA', text: 'Gói data Viettel' },
            { value: 'MOBIFONE_DATA', text: 'Gói data Mobifone' },
            { value: 'VINAPHONE_DATA', text: 'Gói data Vinaphone' }
        ],
        // DIGITAL_ACCOUNTS (Tài khoản số)
        'DIGITAL_ACCOUNTS': [
            { value: 'EMAIL', text: 'Tài khoản email' },
            { value: 'SOCIAL', text: 'Tài khoản social media' },
            { value: 'STREAMING', text: 'Tài khoản streaming' },
            { value: 'APP', text: 'Tài khoản ứng dụng' }
        ],
        // GIFTS_VOUCHERS (Quà tặng & Voucher)
        'GIFTS_VOUCHERS': [
            { value: 'GIFT', text: 'Thẻ quà tặng' },
            { value: 'VOUCHER', text: 'Voucher' },
            { value: 'COUPON', text: 'Coupon' },
            { value: 'PROMO', text: 'Mã khuyến mãi' }
        ],
        // SOFTWARE_LICENSES (Phần mềm & License)
        'SOFTWARE_LICENSES': [
            { value: 'SOFTWARE', text: 'Key phần mềm' },
            { value: 'LICENSE', text: 'License key' },
            { value: 'ACTIVATION', text: 'Mã kích hoạt' },
            { value: 'SUBSCRIPTION', text: 'Subscription' }
        ],
        // GAMING (Gaming)
        'GAMING': [
            { value: 'GAME_ACC', text: 'Tài khoản game' },
            { value: 'GAME_ITEM', text: 'Item game' },
            { value: 'GAME_CURRENCY', text: 'Tiền tệ game' },
            { value: 'GAME_CODE', text: 'Gift code game' }
        ],
        // OTHER (Khác)
        'OTHER': [
            { value: 'OTHER', text: 'Khác' }
        ]
    };
    
    // Handle category selection change
    function updateProductTypeOptions() {
        const categorySelect = document.querySelector('select[name="categoryId"]');
        const productTypeSelect = document.getElementById('productTypeSelect');
        const selectedCategoryText = categorySelect.options[categorySelect.selectedIndex].text;
        
        // Clear existing options except the first one
        productTypeSelect.innerHTML = '<option value="">-- Chọn kiểu sản phẩm --</option>';
        
        // Map Vietnamese display names to English category names
        const displayNameToCategoryMap = {
            'Viễn thông': 'TELECOM',
            'Tài khoản số': 'DIGITAL_ACCOUNTS',
            'Quà tặng & Voucher': 'GIFTS_VOUCHERS',
            'Phần mềm & License': 'SOFTWARE_LICENSES',
            'Gaming': 'GAMING',
            'Khác': 'OTHER'
        };
        
        // Get English category name from Vietnamese display name
        const englishCategoryName = displayNameToCategoryMap[selectedCategoryText];
        
        // Add options based on selected category
        if (englishCategoryName && categoryProductTypeMap[englishCategoryName]) {
            categoryProductTypeMap[englishCategoryName].forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option.value;
                optionElement.textContent = option.text;
                productTypeSelect.appendChild(optionElement);
            });
        }
        
        // Reset product type guide
        updateProductTypeGuide();
    }
    
    // Initialize event listener for category change
    document.addEventListener('DOMContentLoaded', function() {
        const categorySelect = document.querySelector('select[name="categoryId"]');
        if (categorySelect) {
            categorySelect.addEventListener('change', updateProductTypeOptions);
            // Initialize on page load
            updateProductTypeOptions();
        }
    });
</script>

</body>
</html>
