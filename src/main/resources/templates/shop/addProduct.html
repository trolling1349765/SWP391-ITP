<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head th:replace="~{Included/ShopHeader :: shopHead}">
    <link rel="stylesheet" th:href="@{/assets/css/shop/addProduct.css}">
    <link rel="stylesheet" th:href="@{/assets/css/shop/excel-processing.css}">
</head>
<body style="margin:0;padding-top:56px;overflow-x:hidden;">
<div th:replace="~{Included/ShopHeader :: shopHeader}"></div>

<div class="container-fluid p-0">
    <div class="row g-0">
        <div class="col-md-3 col-lg-2 p-0" style="position:fixed;top:56px;bottom:0;left:0;z-index:1000;">
        <aside th:replace="~{Included/ShopSidebar :: sidebar}"></aside>
    </div>

        <div class="col-md-9 col-lg-10 p-3 ms-auto">
            <div class="d-flex align-items-center justify-content-between mb-3">
                <h4 class="mb-0">Thêm sản phẩm</h4>
                <a th:href="@{/shop/dashboard}" class="btn btn-outline-secondary btn-sm">← Dashboard</a>
            </div>

            <form th:action="@{/shop/addProduct}" th:object="${form}" method="post" enctype="multipart/form-data"
                  class="row g-3">

                    <div class="col-md-8">
                        <label class="form-label">Tên sản phẩm <span class="text-danger">*</span></label>
                        <input th:field="*{productName}" class="form-control" placeholder="Nhập tên..." required/>
                        <div class="invalid-feedback">Vui lòng nhập tên sản phẩm</div>
                    </div>

                    <div class="col-md-4">
                    <label class="form-label">Giá <span class="text-danger">*</span></label>
                    <input th:field="*{price}" id="priceInput" type="number" min="0" step="0.01" class="form-control"
                           placeholder="0.00" required/>
                    <div class="invalid-feedback">Vui lòng nhập giá sản phẩm</div>
                    <small class="text-muted">Giá này sẽ được tự động điền khi chọn mệnh giá (có thể chỉnh sửa)</small>
                    </div>

                    <div class="col-md-6" th:if="${categories != null}">
                    <label class="form-label">Phân loại sản phẩm <span class="text-danger">*</span></label>
                    <select th:field="*{categoryId}" class="form-select" onchange="updateProductTypeOptions()" required>
                        <option value="">-- Chọn phân loại --</option>
                        <option th:each="c : ${categories}" th:value="${c.id}"
                                th:text="${@shopController.getCategoryDisplayName(c.categoryName)}">Cat
                        </option>
                        </select>
                    <div class="invalid-feedback">Vui lòng chọn phân loại sản phẩm</div>
                    </div>
                    <input th:if="${categories == null}" type="hidden" th:field="*{categoryId}"/>

                <div class="col-md-6">
                    <label class="form-label">Kiểu sản phẩm <span class="text-danger">*</span></label>
                    <select th:field="*{productType}" id="productTypeSelect" class="form-select" required
                            onchange="updateProductTypeGuide()">
                        <option value="">-- Chọn kiểu sản phẩm --</option>
                        <!-- Options will be populated dynamically based on category selection -->
                    </select>
                    <div class="invalid-feedback">Vui lòng chọn kiểu sản phẩm</div>
                </div>

                <div class="col-md-6" id="faceValueSection" style="display: none;">
                    <label class="form-label">Mệnh giá <span class="text-danger">*</span></label>
                    <select id="faceValueSelect" name="faceValue" class="form-select"
                            onchange="updatePriceFromFaceValue()">
                        <option value="">-- Chọn mệnh giá --</option>
                        <option value="10000">10,000 ₫</option>
                        <option value="20000">20,000 ₫</option>
                        <option value="50000">50,000 ₫</option>
                        <option value="100000">100,000 ₫</option>
                        <option value="200000">200,000 ₫</option>
                        <option value="500000">500,000 ₫</option>
                        <option value="custom">Tùy chỉnh</option>
                    </select>
                    <div class="invalid-feedback">Vui lòng chọn mệnh giá</div>
                </div>

                <!-- Business Fields -->
                <div class="col-md-6">
                    <label class="form-label">Nhà cung cấp</label>
                    <input name="supplier" type="text" class="form-control" placeholder="Tên nhà cung cấp"/>
                    <small class="text-muted">Tên công ty/nhà cung cấp sản phẩm</small>
                    </div>

                    <div class="col-md-6">
                    <label class="form-label">Phí sàn (%)</label>
                    <input name="platformFee" type="number" min="0" max="50" step="0.1" class="form-control"
                           placeholder="0" value="0" id="platformFeeInput" readonly/>
                    <small class="text-muted">Phí sàn tự động theo loại sản phẩm</small>
                    <div id="platformFeeInfo" class="mt-1"></div>
                </div>

                <div class="col-md-12">
                    <label class="form-label">Mô tả ngắn</label>
                    <textarea th:field="*{description}" class="form-control" rows="2"
                              placeholder="Mô tả ngắn gọn về sản phẩm"></textarea>
                </div>

                <div class="col-md-12">
                    <label class="form-label">Mô tả chi tiết</label>
                    <textarea th:field="*{detailedDescription}" class="form-control" rows="4"
                              placeholder="Mô tả chi tiết về sản phẩm, tính năng, cách sử dụng..."></textarea>
                </div>

                <div class="col-md-12">
                        <label class="form-label">Ảnh (tùy chọn)</label>
                    <input th:field="*{file}" type="file" class="form-control" accept="image/*"/>
                    <small class="text-muted">Chọn file ảnh để upload</small>
                </div>

                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">Thông tin Sản phẩm</h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted mb-3">Bắt buộc upload file Excel để nhập sản phẩm</p>

                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <label class="form-label mb-0">File Excel chứa Sản phẩm</label>
                                    <div class="btn-group" role="group">
                                        <a th:href="@{/shop/addProductTemplate}" class="btn btn-outline-primary btn-sm">
                                            Tải Template
                                        </a>
                                        <button type="button" class="btn btn-outline-danger btn-sm"
                                                onclick="clearFileInput()">
                                            Xóa File
                                        </button>
                                    </div>
                                </div>
                                <input th:field="*{serialFile}" type="file" class="form-control" accept=".xlsx,.xls"
                                       required id="serialFileInput" onchange="previewExcelFile(this)"/>
                                <small class="text-muted">Upload file Excel theo template chuẩn</small>
                                <div id="fileInfo" class="mt-2"></div>

                                <!-- Excel Preview Table -->
                                <div id="excelPreview" class="mt-3" style="display: none;">
                                    <div class="card border-warning">
                                        <div class="card-header bg-warning text-dark">
                                            <h6 class="mb-0">Danh sách sản phẩm sẽ được thêm vào</h6>
                                        </div>
                                        <div class="card-body p-0">
                                            <div class="table-responsive">
                                                <table class="table table-striped table-hover mb-0">
                                                    <thead class="table-dark">
                                                    <tr>
                                                        <th>#</th>
                                                        <th>Mã sản phẩm</th>
                                                        <th>Mã bí mật</th>
                                                        <th>Mệnh giá</th>
                                                        <th>Thông tin</th>
                                                        <th>Trạng thái</th>
                                                    </tr>
                                                    </thead>
                                                    <tbody id="excelPreviewBody">
                                                    <!-- Dynamic content will be inserted here -->
                                                    </tbody>
                                                </table>
                                            </div>
                                            <div class="card-footer bg-light">
                                                <small class="text-muted">
                                                    <i class="fas fa-info-circle"></i>
                                                    Tổng cộng: <span id="totalSerials">0</span> sản phẩm sẽ được thêm vào
                                                    danh mục này
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                    </div>

                            <!-- Import Results Display -->
                            <div id="importResults" class="mb-3" style="display: none;">
                                <div class="card">
                                    <div class="card-header bg-success text-white">
                                        <h6 class="mb-0">Kết quả Import</h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="importSummary" class="row g-2 mb-3"></div>
                                        <div id="importDetails" class="row g-2 mb-3"></div>

                                        <!-- Serial List Table -->
                                        <div id="serialListSection" class="mt-3" style="display: none;">
                                            <div class="card border-info">
                                                <div class="card-header bg-info text-white">
                                                    <h6 class="mb-0">Danh Sách Serials Đã Import</h6>
                                                </div>
                                                <div class="card-body p-0">
                                                    <div class="table-responsive">
                                                        <table class="table table-striped table-hover mb-0">
                                                            <thead class="table-dark">
                                                            <tr>
                                                                <th>#</th>
                                                                <th>Serial Code</th>
                                                                <th>Secret Code</th>
                                                                <th>Face Value</th>
                                                                <th>Information</th>
                                                                <th>Status</th>
                                                            </tr>
                                                            </thead>
                                                            <tbody id="serialListBody">
                                                            <!-- Dynamic content will be inserted here -->
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                    </div>

                                        <!-- Validation Check Table -->
                                        <div id="validationTableSection" class="mt-3" style="display: none;">
                                            <div class="card border-warning">
                                                <div class="card-header bg-warning text-dark">
                                                    <h6 class="mb-0">Bảng Kiểm Tra Validation</h6>
                                                </div>
                                                <div class="card-body p-0">
                                                    <div class="table-responsive">
                                                        <table class="table table-striped table-hover mb-0">
                                                            <thead class="table-warning">
                                                            <tr>
                                                                <th>Dòng</th>
                                                                <th>Serial Code</th>
                                                                <th>Validation</th>
                                                                <th>Lỗi</th>
                                                                <th>Cảnh Báo</th>
                                                                <th>Trạng Thái</th>
                                                            </tr>
                                                            </thead>
                                                            <tbody id="validationTableBody">
                                                            <!-- Dynamic content will be inserted here -->
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
            </div>
        </div>
    </div>
</div>

                            <div class="alert alert-info">
                                <h6>Hướng dẫn tạo file Excel:</h6>
                                <div class="phone-card-guide" style="display: none;">
                                    <strong>Thẻ điện thoại:</strong>
                                    <ul class="mb-0">
                                        <li><strong>Mã sản phẩm:</strong> Mã thẻ điện thoại (VD: 1234567890123456)</li>
                                        <li><strong>Mã bí mật:</strong> Mã PIN thẻ (VD: ABCD1234)</li>
                                        <li><strong>Mệnh giá:</strong> Mệnh giá thẻ (VD: 10000)</li>
                                        <li><strong>Thông tin:</strong> Thông tin bổ sung (VD: Thẻ Viettel 10K)</li>
                                    </ul>
                                </div>

                                <div class="email-account-guide" style="display: none;">
                                    <strong>Tài khoản email:</strong>
                                    <ul class="mb-0">
                                        <li><strong>Mã sản phẩm:</strong> Email address (VD: user123@gmail.com)</li>
                                        <li><strong>Mã bí mật:</strong> Password (VD: password123)</li>
                                        <li><strong>Mệnh giá:</strong> Giá bán tài khoản (có thể tùy chỉnh)</li>
                                        <li><strong>Thông tin:</strong> Thông tin bổ sung (đã verify, chưa verify,
                                            etc.)
                                        </li>
                                    </ul>
                                </div>
                                <div class="gift-card-guide" style="display: none;">
                                    <strong>Thẻ quà tặng:</strong>
                                    <ul class="mb-0">
                                        <li><strong>Mã sản phẩm:</strong> Mã thẻ quà tặng</li>
                                        <li><strong>Mã bí mật:</strong> Pin code (nếu có)</li>
                                        <li><strong>Mệnh giá:</strong> Mệnh giá thẻ</li>
                                        <li><strong>Thông tin:</strong> Loại thẻ, hạn sử dụng</li>
                                    </ul>
                                </div>
                                <div class="software-key-guide" style="display: none;">
                                    <strong>Key phần mềm:</strong>
                                    <ul class="mb-0">
                                        <li><strong>Mã sản phẩm:</strong> License key (VD: XXXXX-XXXXX-XXXXX)</li>
                                        <li><strong>Mã bí mật:</strong> Activation code (nếu có)</li>
                                        <li><strong>Mệnh giá:</strong> Giá bán key</li>
                                        <li><strong>Thông tin:</strong> Tên phần mềm, phiên bản</li>
                                    </ul>
                                </div>
                                <div class="default-guide">
                                    <ol class="mb-0">
                                        <li>Chọn kiểu sản phẩm để xem hướng dẫn chi tiết</li>
                                        <li>Download template Excel chuẩn</li>
                                        <li>Upload file Excel để hệ thống tự động đếm số lượng</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-12">
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary" onclick="return confirmSubmit()">Tạo sản phẩm
                        </button>
                        <a th:href="@{/shop/dashboard}" class="btn btn-secondary">Hủy</a>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- Include Modular JavaScript -->
<script th:src="@{/assets/js/shop/excel-processing.js}"></script>
<script th:src="@{/assets/js/shop/form-manager.js}"></script>
<script th:src="@{/assets/js/shop/excel-processor.js}"></script>
<script th:src="@{/assets/js/shop/submit-manager.js}"></script>
<script th:src="@{/assets/js/shop/add-product-controller.js}"></script>

<script>
// Simple JavaScript for Add Product functionality

// Platform fee configuration
const platformFeeConfig = {
    'VIETTEL': { fee: 3, description: 'Thẻ điện thoại - Phí thấp' },
    'MOBIFONE': { fee: 3, description: 'Thẻ điện thoại - Phí thấp' },
    'VINAPHONE': { fee: 3, description: 'Thẻ điện thoại - Phí thấp' },
    'VIETTEL_DATA': { fee: 3, description: 'Gói data - Phí thấp' },
    'MOBIFONE_DATA': { fee: 3, description: 'Gói data - Phí thấp' },
    'VINAPHONE_DATA': { fee: 3, description: 'Gói data - Phí thấp' },
    'EMAIL': { fee: 7, description: 'Tài khoản email - Phí trung bình' },
    'SOCIAL': { fee: 7, description: 'Social media - Phí trung bình' },
    'STREAMING': { fee: 7, description: 'Streaming - Phí trung bình' },
    'APP': { fee: 7, description: 'Ứng dụng - Phí trung bình' },
    'GIFT': { fee: 8, description: 'Thẻ quà tặng - Phí trung bình' },
    'VOUCHER': { fee: 8, description: 'Voucher - Phí trung bình' },
    'COUPON': { fee: 8, description: 'Coupon - Phí trung bình' },
    'PROMO': { fee: 8, description: 'Mã khuyến mãi - Phí trung bình' },
    'SOFTWARE': { fee: 12, description: 'Key phần mềm - Phí cao' },
    'LICENSE': { fee: 12, description: 'License key - Phí cao' },
    'ACTIVATION': { fee: 12, description: 'Mã kích hoạt - Phí cao' },
    'SUBSCRIPTION': { fee: 12, description: 'Subscription - Phí cao' },
    'GAME_ACC': { fee: 10, description: 'Tài khoản game - Phí biến động' },
    'GAME_ITEM': { fee: 10, description: 'Item game - Phí biến động' },
    'GAME_CURRENCY': { fee: 10, description: 'Tiền tệ game - Phí biến động' },
    'GAME_CODE': { fee: 10, description: 'Gift code game - Phí biến động' },
    'OTHER': { fee: 7, description: 'Khác - Phí mặc định' }
};

// Category to ProductType mapping
const categoryProductTypeMap = {
    'TELECOM': [
        { value: 'VIETTEL', text: 'Thẻ Viettel' },
        { value: 'MOBIFONE', text: 'Thẻ Mobifone' },
        { value: 'VINAPHONE', text: 'Thẻ Vinaphone' },
        { value: 'VIETTEL_DATA', text: 'Gói data Viettel' },
        { value: 'MOBIFONE_DATA', text: 'Gói data Mobifone' },
        { value: 'VINAPHONE_DATA', text: 'Gói data Vinaphone' }
    ],
    'DIGITAL_ACCOUNTS': [
        { value: 'EMAIL', text: 'Tài khoản email' },
        { value: 'SOCIAL', text: 'Tài khoản social media' },
        { value: 'STREAMING', text: 'Tài khoản streaming' },
        { value: 'APP', text: 'Tài khoản ứng dụng' }
    ],
    'GIFTS_VOUCHERS': [
        { value: 'GIFT', text: 'Thẻ quà tặng' },
        { value: 'VOUCHER', text: 'Voucher' },
        { value: 'COUPON', text: 'Coupon' },
        { value: 'PROMO', text: 'Mã khuyến mãi' }
    ],
    'SOFTWARE_LICENSES': [
        { value: 'SOFTWARE', text: 'Key phần mềm' },
        { value: 'LICENSE', text: 'License key' },
        { value: 'ACTIVATION', text: 'Mã kích hoạt' },
        { value: 'SUBSCRIPTION', text: 'Subscription' }
    ],
    'GAMING': [
        { value: 'GAME_ACC', text: 'Tài khoản game' },
        { value: 'GAME_ITEM', text: 'Item game' },
        { value: 'GAME_CURRENCY', text: 'Tiền tệ game' },
        { value: 'GAME_CODE', text: 'Gift code game' }
    ],
    'OTHER': [
        { value: 'OTHER', text: 'Khác' }
    ]
};

// Handle category selection change
function updateProductTypeOptions() {
    const categorySelect = document.getElementById('categoryId');
    const productTypeSelect = document.getElementById('productTypeSelect');
    
    if (!categorySelect || !productTypeSelect) {
        return;
    }
    
    const selectedIndex = categorySelect.selectedIndex;
    const selectedCategoryText = categorySelect.options[selectedIndex].text;
    const selectedCategoryValue = categorySelect.options[selectedIndex].value;
    
    // Clear existing options except the first one
    productTypeSelect.innerHTML = '<option value="">-- Chọn kiểu sản phẩm --</option>';
    
    // If no category selected, return
    if (selectedIndex === 0 || !selectedCategoryValue) {
        return;
    }
    
    // Map Vietnamese display names to English category names
    const displayNameToCategoryMap = {
        'Viễn thông': 'TELECOM',
        'Tài khoản số': 'DIGITAL_ACCOUNTS',
        'Quà tặng & Voucher': 'GIFTS_VOUCHERS',
        'Phần mềm & License': 'SOFTWARE_LICENSES',
        'Gaming': 'GAMING',
        'Khác': 'OTHER'
    };
    
    // Get English category name from Vietnamese display name
    const englishCategoryName = displayNameToCategoryMap[selectedCategoryText];
    
    // Add options based on selected category
    if (englishCategoryName && categoryProductTypeMap[englishCategoryName]) {
        categoryProductTypeMap[englishCategoryName].forEach(option => {
            const optionElement = document.createElement('option');
            optionElement.value = option.value;
            optionElement.textContent = option.text;
            productTypeSelect.appendChild(optionElement);
        });
    }
    
    // Reset product type guide
    updateProductTypeGuide();
}

// Handle product type selection
function updateProductTypeGuide() {
    const productType = document.querySelector('select[name="productType"]').value;
    const faceValueSection = document.getElementById('faceValueSection');
    const platformFeeInput = document.getElementById('platformFeeInput');
    const platformFeeInfo = document.getElementById('platformFeeInfo');
    
    // Hide all guides first
    if (faceValueSection) {
        faceValueSection.style.display = 'none';
        // Remove required attribute when hiding
        const faceValueSelect = document.getElementById('faceValueSelect');
        if (faceValueSelect) {
            faceValueSelect.removeAttribute('required');
        }
    }
    
    // Clear platform fee info
    if (platformFeeInfo) {
        platformFeeInfo.innerHTML = '';
    }
    
    // Clear platform fee input
    if (platformFeeInput) {
        platformFeeInput.value = '';
    }
    
    if (!productType) {
        return;
    }
    
    // Show face value section for telecom products
    if (['VIETTEL', 'MOBIFONE', 'VINAPHONE', 'VIETTEL_DATA', 'MOBIFONE_DATA', 'VINAPHONE_DATA'].includes(productType)) {
        if (faceValueSection) {
            faceValueSection.style.display = 'block';
            // Add required attribute when section is visible
            const faceValueSelect = document.getElementById('faceValueSelect');
            if (faceValueSelect) {
                faceValueSelect.setAttribute('required', 'required');
            }
        }
    } else {
        // Remove required attribute when section is hidden
        const faceValueSelect = document.getElementById('faceValueSelect');
        if (faceValueSelect) {
            faceValueSelect.removeAttribute('required');
        }
    }
    
    // Update platform fee
    if (platformFeeConfig[productType]) {
        const config = platformFeeConfig[productType];
        if (platformFeeInput) {
            platformFeeInput.value = config.fee;
        }
        if (platformFeeInfo) {
            platformFeeInfo.innerHTML = `<small class="text-info">${config.description}</small>`;
        }
    }
}

// Update price from face value selection
function updatePriceFromFaceValue() {
    const faceValueSelect = document.getElementById('faceValueSelect');
    const priceInput = document.getElementById('priceInput');
    
    if (!faceValueSelect || !priceInput) {
        return;
    }
    
    const selectedValue = faceValueSelect.value;
    
    if (selectedValue === 'custom') {
        // Show custom price input
        priceInput.readOnly = false;
        priceInput.placeholder = 'Nhập giá tùy chỉnh';
        priceInput.value = '';
    } else if (selectedValue && selectedValue !== '') {
        // Set price from face value but allow editing
        priceInput.value = selectedValue;
        priceInput.readOnly = false;
        priceInput.placeholder = 'Giá từ mệnh giá (có thể chỉnh sửa)';
    } else {
        // Clear price
        priceInput.value = '';
        priceInput.readOnly = false;
        priceInput.placeholder = 'Nhập giá sản phẩm';
    }
}

// Preview Excel file
function previewExcelFile(input) {
    const file = input.files[0];
    if (!file) {
        hideExcelPreview();
        return;
    }
    
    console.log('File selected:', file.name);
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            
            console.log('Excel data loaded:', jsonData);
            parseExcelFile(jsonData);
            
        } catch (error) {
            console.error('Error reading Excel:', error);
            showExcelPreviewError('Lỗi đọc file Excel: ' + error.message);
        }
    };
    
    reader.readAsArrayBuffer(file);
}

// Parse Excel file and show preview
function parseExcelFile(data) {
    console.log('Parsing Excel data:', data);
    
    if (data.length < 2) {
        showExcelPreviewError('File Excel không có dữ liệu hoặc định dạng không đúng');
        return;
    }
    
    const headers = data[0];
    const expectedHeaders = ['Serial Code', 'Secret Code'];
    
    // Check if headers match expected format
    if (!expectedHeaders.every(header => headers.includes(header))) {
        showExcelPreviewError('File Excel không đúng định dạng. Cần có các cột: ' + expectedHeaders.join(', '));
        return;
    }
    
    const serials = [];
    let validCount = 0;
    let errorCount = 0;
    let duplicateCount = 0;
    
    for (let i = 1; i < data.length; i++) {
        const row = data[i];
        if (row.length < 2) continue;
        
        const serialCode = row[0] ? String(row[0]).trim() : '';
        const secretCode = row[1] ? String(row[1]).trim() : '';
        
        if (serialCode && secretCode) {
            // Check for duplicates within the file
            const isDuplicateInFile = serials.some(s => s.serialCode === serialCode);
            
            serials.push({
                serialCode: serialCode,
                secretCode: secretCode,
                status: isDuplicateInFile ? 'duplicate' : 'ready'
            });
            
            if (isDuplicateInFile) {
                duplicateCount++;
            } else {
                validCount++;
            }
        } else {
            serials.push({
                serialCode: serialCode || '',
                secretCode: secretCode || '',
                status: 'error'
            });
            errorCount++;
        }
    }
    
    if (serials.length === 0) {
        showExcelPreviewError('Không tìm thấy dữ liệu sản phẩm nào trong file Excel');
        return;
    }
    
    console.log('Serials parsed:', serials);
    
    // Check duplicates in database
    checkSerialDuplicates(serials, validCount, errorCount, duplicateCount);
}

// Check serial duplicates in database
function checkSerialDuplicates(serials, validCount, errorCount, duplicateCount) {
    const validSerials = serials.filter(s => s.status === 'ready');
    
    if (validSerials.length === 0) {
        showExcelPreview(serials, validCount, errorCount, duplicateCount);
        return;
    }
    
    // Send AJAX request to check duplicates
    const serialCodes = validSerials.map(s => s.serialCode);
    
    console.log('Checking duplicates for:', serialCodes);
    
    fetch('/itp/shop/check-serial-duplicates', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(serialCodes)
    })
    .then(response => response.json())
    .then(data => {
        console.log('Duplicate check response:', data);
        
        // Update serial status based on database check
        serials.forEach(serial => {
            if (serial.status === 'ready' && data.duplicates.includes(serial.serialCode)) {
                serial.status = 'duplicate_db';
            }
        });
        
        const dbDuplicateCount = data.duplicates.length;
        const finalValidCount = validCount - dbDuplicateCount;
        
        showExcelPreview(serials, finalValidCount, errorCount, duplicateCount, dbDuplicateCount);
    })
    .catch(error => {
        console.error('Error checking duplicates:', error);
        showExcelPreview(serials, validCount, errorCount, duplicateCount);
    });
}

// Show Excel preview table
function showExcelPreview(serials, validCount, errorCount, duplicateCount = 0, dbDuplicateCount = 0) {
    const previewDiv = document.getElementById('excelPreview');
    if (!previewDiv) return;
    
    console.log('Showing preview:', { serials, validCount, errorCount, duplicateCount, dbDuplicateCount });
    
    // Update submit button state
    updateSubmitButtonState(validCount, duplicateCount, dbDuplicateCount);
    
    let tableHTML = `
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0">Danh sách sản phẩm sẽ được thêm vào</h6>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-sm table-striped mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>STT</th>
                                <th>Mã sản phẩm</th>
                                <th>Mã bí mật</th>
                                <th>Trạng thái</th>
                            </tr>
                        </thead>
                        <tbody>
    `;
    
    serials.forEach((serial, index) => {
        let statusBadge;
        switch(serial.status) {
            case 'ready':
                statusBadge = '<span class="badge bg-success">Sẵn sàng</span>';
                break;
            case 'duplicate':
                statusBadge = '<span class="badge bg-warning">Trùng trong file</span>';
                break;
            case 'duplicate_db':
                statusBadge = '<span class="badge bg-danger">Trùng trong DB</span>';
                break;
            case 'error':
            default:
                statusBadge = '<span class="badge bg-danger">Có lỗi</span>';
                break;
        }
        
        tableHTML += `
            <tr>
                <td>${index + 1}</td>
                <td>${serial.serialCode}</td>
                <td>${serial.secretCode}</td>
                <td>${statusBadge}</td>
            </tr>
        `;
    });
    
    tableHTML += `
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer">
                <small class="text-muted">
                    Tổng cộng: ${serials.length} sản phẩm sẽ được thêm vào
                    ${validCount > 0 ? ` (${validCount} hợp lệ)` : ''}
                    ${duplicateCount > 0 ? ` (${duplicateCount} trùng trong file)` : ''}
                    ${dbDuplicateCount > 0 ? ` (${dbDuplicateCount} trùng trong DB)` : ''}
                    ${errorCount > 0 ? ` (${errorCount} có lỗi)` : ''}
                </small>
            </div>
        </div>
    `;
    
    previewDiv.innerHTML = tableHTML;
    previewDiv.style.display = 'block';
}

// Show Excel preview error
function showExcelPreviewError(message) {
    const previewDiv = document.getElementById('excelPreview');
    if (!previewDiv) return;
    
    previewDiv.innerHTML = `
        <div class="alert alert-danger mt-3">
            <strong>Lỗi:</strong> ${message}
        </div>
    `;
    previewDiv.style.display = 'block';
}

// Hide Excel preview
function hideExcelPreview() {
    const previewDiv = document.getElementById('excelPreview');
    if (previewDiv) {
        previewDiv.style.display = 'none';
        previewDiv.innerHTML = '';
    }
}

// Update submit button state based on serial validation
function updateSubmitButtonState(validCount, duplicateCount, dbDuplicateCount) {
    const submitButton = document.querySelector('button[type="submit"]');
    const totalDuplicates = duplicateCount + dbDuplicateCount;
    
    if (!submitButton) return;
    
    console.log('Updating submit button state:', { validCount, duplicateCount, dbDuplicateCount, totalDuplicates });
    
    if (totalDuplicates > 0) {
        // Disable submit button if there are duplicates
        submitButton.disabled = true;
        submitButton.classList.remove('btn-primary');
        submitButton.classList.add('btn-secondary');
        submitButton.title = `Không thể submit vì có ${totalDuplicates} sản phẩm trùng`;
        
        // Add warning message
        let warningMsg = document.getElementById('submitWarning');
        if (!warningMsg) {
            warningMsg = document.createElement('div');
            warningMsg.id = 'submitWarning';
            warningMsg.className = 'alert alert-warning mt-2';
            submitButton.parentNode.appendChild(warningMsg);
        }
        warningMsg.innerHTML = `Không thể tạo sản phẩm vì có ${totalDuplicates} sản phẩm trùng. Vui lòng sửa file Excel.`;
    } else if (validCount > 0) {
        // Enable submit button if there are valid serials
        submitButton.disabled = false;
        submitButton.classList.remove('btn-secondary');
        submitButton.classList.add('btn-primary');
        submitButton.title = `Có thể tạo sản phẩm với ${validCount} sản phẩm hợp lệ`;
        
        // Remove warning message
        const warningMsg = document.getElementById('submitWarning');
        if (warningMsg) {
            warningMsg.remove();
        }
    } else {
        // Disable if no valid serials
        submitButton.disabled = true;
        submitButton.classList.remove('btn-primary');
        submitButton.classList.add('btn-secondary');
        submitButton.title = 'Không có sản phẩm hợp lệ nào';
        
        // Add warning message
        let warningMsg = document.getElementById('submitWarning');
        if (!warningMsg) {
            warningMsg = document.createElement('div');
            warningMsg.id = 'submitWarning';
            warningMsg.className = 'alert alert-warning mt-2';
            submitButton.parentNode.appendChild(warningMsg);
        }
        warningMsg.innerHTML = 'Không có sản phẩm hợp lệ nào để tạo sản phẩm.';
    }
}

// Clear Excel file input
function clearFileInput() {
    const fileInput = document.getElementById('serialFileInput');
    const fileInfo = document.getElementById('fileInfo');
    const previewDiv = document.getElementById('excelPreview');
    
    if (fileInput) {
        fileInput.value = '';
    }
    
    if (fileInfo) {
        fileInfo.innerHTML = '';
    }
    
    if (previewDiv) {
        previewDiv.style.display = 'none';
        previewDiv.innerHTML = '';
    }
    
    // Reset submit button state
    const submitButton = document.querySelector('button[type="submit"]');
    if (submitButton) {
        submitButton.disabled = false;
        submitButton.classList.remove('btn-secondary');
        submitButton.classList.add('btn-primary');
        submitButton.title = '';
    }
    
    // Remove warning message
    const warningMsg = document.getElementById('submitWarning');
    if (warningMsg) {
        warningMsg.remove();
    }
}

// Validate form before submit
function validateForm() {
    let isValid = true;
    let errorMessages = [];
    
    // Validate required fields
    const productName = document.querySelector('input[name="productName"]').value.trim();
    if (!productName) {
        errorMessages.push('Tên sản phẩm không được để trống');
        isValid = false;
    }
    
    const price = document.querySelector('input[name="price"]').value;
    if (!price || parseFloat(price) <= 0) {
        errorMessages.push('Giá sản phẩm phải lớn hơn 0');
        isValid = false;
    }
    
    const categoryId = document.querySelector('select[name="categoryId"]').value;
    if (!categoryId) {
        errorMessages.push('Vui lòng chọn phân loại sản phẩm');
        isValid = false;
    }
    
    const productType = document.querySelector('select[name="productType"]').value;
    if (!productType) {
        errorMessages.push('Vui lòng chọn kiểu sản phẩm');
        isValid = false;
    }
    
    // Check if face value section is visible and required
    const faceValueSection = document.getElementById('faceValueSection');
    if (faceValueSection && faceValueSection.style.display !== 'none') {
        const faceValue = document.getElementById('faceValueSelect').value;
        if (!faceValue) {
            errorMessages.push('Vui lòng chọn mệnh giá');
            isValid = false;
        }
    }
    
    // Validate Excel file
    const excelFile = document.querySelector('input[name="serialFile"]').files[0];
    if (!excelFile) {
        errorMessages.push('Vui lòng upload file Excel chứa danh sách sản phẩm');
        isValid = false;
    }
    
    // Check Excel preview if exists
    const previewDiv = document.getElementById('excelPreview');
    if (previewDiv && previewDiv.style.display !== 'none') {
        const validBadges = previewDiv.querySelectorAll('.badge.bg-success');
        if (validBadges.length === 0) {
            errorMessages.push('Không có sản phẩm hợp lệ nào trong file Excel');
            isValid = false;
        }
    }
    
    if (!isValid) {
        alert('Vui lòng kiểm tra lại thông tin:\n\n' + errorMessages.join('\n'));
        return false;
    }
    
    return true;
}

// Confirm submit with duplicate validation
function confirmSubmit() {
    // First validate form
    if (!validateForm()) {
        return false;
    }
    
    const productName = document.querySelector('input[name="productName"]').value;
    const excelFile = document.getElementById('serialFileInput').files[0];
    const previewDiv = document.getElementById('excelPreview');
    
    // Check if there are any duplicate serials
    if (previewDiv && previewDiv.style.display !== 'none') {
        const duplicateBadges = previewDiv.querySelectorAll('.badge.bg-danger, .badge.bg-warning');
        if (duplicateBadges.length > 0) {
            alert('Không thể tạo sản phẩm vì có sản phẩm trùng!\n\nVui lòng:\n- Xóa các sản phẩm trùng trong file Excel\n- Hoặc xóa file và upload file mới\n- Hoặc sử dụng mã sản phẩm khác');
            return false;
        }
        
        // Check if there are any valid serials
        const validBadges = previewDiv.querySelectorAll('.badge.bg-success');
        if (validBadges.length === 0) {
            alert('Không có sản phẩm hợp lệ nào để thêm!\n\nVui lòng kiểm tra lại file Excel.');
            return false;
        }
    }
    
    let confirmMessage = `Bạn có chắc chắn muốn tạo sản phẩm "${productName}"?`;
    
    if (excelFile) {
        confirmMessage += `\n\nFile Excel "${excelFile.name}" sẽ được xử lý để thêm sản phẩm.`;
    }
    
    const confirmed = confirm(confirmMessage);
    
    if (confirmed) {
        // Show loading state on submit button
        const submitButton = document.querySelector('button[type="submit"]');
        if (submitButton) {
            submitButton.classList.add('btn-loading');
            submitButton.disabled = true;
        }
    }
    
    return confirmed;
}

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    console.log('Add Product page loaded');
    
    // Initialize platform fee to empty state
    const platformFeeInput = document.getElementById('platformFeeInput');
    const platformFeeInfo = document.getElementById('platformFeeInfo');
    if (platformFeeInput && platformFeeInfo) {
        platformFeeInput.value = '';
        platformFeeInfo.innerHTML = '';
    }
    
    // Add real-time validation
    setupRealTimeValidation();
    
    // Initial call to update product type options
    setTimeout(() => {
        updateProductTypeOptions();
    }, 100);
});
// Setup real-time validation for form fields
function setupRealTimeValidation() {
    // Product name validation
    const productNameInput = document.querySelector('input[name="productName"]');
    if (productNameInput) {
        productNameInput.addEventListener('blur', function() {
            validateField(this, this.value.trim() !== '', 'Tên sản phẩm không được để trống');
        });
    }
    // Price validation
    const priceInput = document.querySelector('input[name="price"]');
    if (priceInput) {
        priceInput.addEventListener('blur', function() {
            const isValid = this.value && parseFloat(this.value) > 0;
            validateField(this, isValid, 'Giá sản phẩm phải lớn hơn 0');
        });
    }
    // Category validation
    const categorySelect = document.querySelector('select[name="categoryId"]');
    if (categorySelect) {
        categorySelect.addEventListener('change', function() {
            validateField(this, this.value !== '', 'Vui lòng chọn phân loại sản phẩm');
        });
    }
    // Product type validation
    const productTypeSelect = document.querySelector('select[name="productType"]');
    if (productTypeSelect) {
        productTypeSelect.addEventListener('change', function() {
            validateField(this, this.value !== '', 'Vui lòng chọn kiểu sản phẩm');
        });
    }
    // Face value validation
    const faceValueSelect = document.getElementById('faceValueSelect');
    if (faceValueSelect) {
        faceValueSelect.addEventListener('change', function() {
            const faceValueSection = document.getElementById('faceValueSection');
            if (faceValueSection && faceValueSection.style.display !== 'none') {
                validateField(this, this.value !== '', 'Vui lòng chọn mệnh giá');
            }
        });
    }
    // Excel file validation
    const excelFileInput = document.querySelector('input[name="serialFile"]');
    if (excelFileInput) {
        excelFileInput.addEventListener('change', function() {
            const isValid = this.files && this.files.length > 0;
            validateField(this, isValid, 'Vui lòng upload file Excel');
        });
    }
}
// Validate individual field and show feedback
function validateField(field, isValid, errorMessage) {
    if (isValid) {
        field.classList.remove('is-invalid');
        field.classList.add('is-valid');
    } else {
        field.classList.remove('is-valid');
        field.classList.add('is-invalid');
    }
}
</script>
</body>
</html>