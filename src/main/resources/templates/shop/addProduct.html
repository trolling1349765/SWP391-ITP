<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head th:replace="~{Included/ShopHeader :: shopHead}"></head>
<body style="margin:0;padding-top:56px;overflow-x:hidden;">
<div th:replace="~{Included/ShopHeader :: shopHeader}"></div>

<div class="container-fluid p-0">
    <div class="row g-0">
        <div class="col-md-3 col-lg-2 p-0" style="position:fixed;top:56px;bottom:0;left:0;z-index:1000;">
            <aside th:replace="~{Included/ShopSidebar :: sidebar}"></aside>
        </div>

        <div class="col-md-9 col-lg-10 p-3 ms-auto">
        <div class="card">
            <div class="card-header">Thêm sản phẩm</div>
            <div class="card-body">
                <form th:action="@{/shop/addProduct}" th:object="${form}" method="post" enctype="multipart/form-data" class="row g-3">

                    <div class="col-md-8">
                        <label class="form-label">Tên sản phẩm</label>
                        <input th:field="*{productName}" class="form-control" placeholder="Nhập tên..." required/>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Giá</label>
                        <input th:field="*{price}" type="number" min="0" step="0.01" class="form-control" placeholder="0.00" required/>
                    </div>

                    <div class="col-md-6" th:if="${categories != null}">
                        <label class="form-label">Danh mục</label>
                        <select th:field="*{categoryId}" class="form-select">
                            <option th:each="c : ${categories}" th:value="${c.id}" th:text="${c.categoryName}">Cat</option>
                        </select>
                    </div>
                    <input th:if="${categories == null}" type="hidden" th:field="*{categoryId}"/>

                    <div class="col-md-6">
                        <label class="form-label">Loại sản phẩm <span class="text-danger">*</span></label>
                        <select th:field="*{productType}" class="form-select" required>
                            <option value="">-- Chọn loại sản phẩm --</option>
                            <option value="PHONE_CARD">Thẻ điện thoại</option>
                            <option value="EMAIL_ACCOUNT">Tài khoản email</option>
                            <option value="GIFT_CARD">Thẻ quà tặng</option>
                            <option value="SOFTWARE_KEY">Key phần mềm</option>
                            <option value="OTHER">Khác</option>
                        </select>
                    </div>

                    <div class="col-12">
                        <label class="form-label">Mô tả ngắn</label>
                        <textarea th:field="*{description}" rows="3" class="form-control" placeholder="Mô tả ngắn gọn về sản phẩm"></textarea>
                    </div>
                    
                    <div class="col-12">
                        <label class="form-label">Mô tả chi tiết</label>
                        <textarea th:field="*{detailedDescription}" rows="5" class="form-control" placeholder="Mô tả chi tiết về sản phẩm, tính năng, cách sử dụng..."></textarea>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Ảnh (tùy chọn)</label>
                        <input type="file" th:field="*{file}" accept="image/*" class="form-control"/>
                    </div>

                    <div class="col-12">
                        <hr class="my-4"/>
                        <h5 class="mb-3">Thông tin Serial & Số lượng</h5>
                        <p class="text-muted small">Bắt buộc upload file Excel để nhập serial và số lượng</p>
                    </div>

                    <div class="col-12">
                        <div class="alert alert-info">
                            <h6>Hướng dẫn theo loại sản phẩm:</h6>
                            <div id="productTypeGuide">
                                <div class="phone-card-guide" style="display: none;">
                                    <strong>Thẻ điện thoại:</strong>
                                    <div class="alert alert-warning mb-2">
                                        <strong>Lưu ý quan trọng:</strong> Mỗi sản phẩm chỉ chứa 1 mệnh giá thẻ duy nhất!
                                    </div>
                                    <ul class="mb-2">
                                        <li><strong>Serial Code(Password):</strong> Mã thẻ (VD: 1234567890123456)</li>
                                        <li><strong>Secret Code:</strong> Mã nạp thẻ (VD: ABCD1234)</li>
                                        <li><strong>Face Value:</strong> Mệnh giá thẻ (VD: 10000 cho thẻ 10K)</li>
                                        <li><strong>Quantity:</strong> Số lượng (thường = 1)</li>
                                    </ul>
                                    <strong>Ví dụ:</strong>
                                    <ul class="mb-0">
                                        <li>Tạo sản phẩm "Thẻ điện thoại 10K" → Face Value = 10000</li>
                                        <li>Tạo sản phẩm "Thẻ điện thoại 20K" → Face Value = 20000</li>
                                        <li>Tạo sản phẩm "Thẻ điện thoại 50K" → Face Value = 50000</li>
                                    </ul>
                                </div>
                                <div class="email-account-guide" style="display: none;">
                                    <strong>Tài khoản email:</strong>
                                    <ul class="mb-0">
                                        <li><strong>Serial Code:</strong> Email address (VD: user123@gmail.com)</li>
                                        <li><strong>Secret Code:</strong> Password (VD: password123)</li>
                                        <li><strong>Face Value:</strong> Giá bán tài khoản</li>
                                        <li><strong>Information:</strong> Thông tin bổ sung (đã verify, chưa verify, etc.)</li>
                                    </ul>
                                </div>
                                <div class="default-guide">
                                    <ol class="mb-0">
                                        <li>Chọn loại sản phẩm để xem hướng dẫn chi tiết</li>
                                        <li>Download template Excel chuẩn</li>
                                        <li>Upload file Excel để hệ thống tự động đếm số lượng</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">File Excel Serial <span class="text-danger">*</span></label>
                        <input type="file" id="excelFile" name="serialFile" accept=".xlsx" class="form-control" required/>
                        <small class="text-muted">File Excel chứa thông tin serial, secret code và số lượng</small>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Tải Template</label>
                        <div class="d-grid">
                            <button type="button" class="btn btn-outline-primary" onclick="downloadAddProductTemplate()">
                                Tải Template Excel
                            </button>
                        </div>
                        <small class="text-muted">Template chuẩn để nhập thông tin serial</small>
                    </div>

                    <div class="col-12 d-flex gap-2">
                        <button class="btn btn-primary" type="submit">Tạo Sản Phẩm</button>
                        <a th:href="@{/shop/dashboard}" class="btn btn-outline-secondary">Hủy</a>
                    </div>
                </form>
                
                <!-- Excel Preview Section -->
                <div id="excelPreview" class="mt-4" style="display: none;">
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">Preview dữ liệu Excel</h5>
                        </div>
                        <div class="card-body">
                            <div id="previewStats" class="row mb-3">
                                <!-- Stats will be populated here -->
                            </div>
                            <div id="previewTable" class="table-responsive">
                                <!-- Table will be populated here -->
                            </div>
                            <div id="previewErrors" class="mt-3">
                                <!-- Errors will be shown here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    function downloadAddProductTemplate() {
        // Tạo link download template cho add product
        const link = document.createElement('a');
        link.href = '/itp/shop/addProductTemplate';
        link.download = 'add_product_template.xlsx';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    // Hiển thị hướng dẫn theo loại sản phẩm
    document.addEventListener('DOMContentLoaded', function() {
        const productTypeSelect = document.querySelector('select[name="productType"]');
        const phoneCardGuide = document.querySelector('.phone-card-guide');
        const emailAccountGuide = document.querySelector('.email-account-guide');
        const defaultGuide = document.querySelector('.default-guide');
        
        if (productTypeSelect) {
            productTypeSelect.addEventListener('change', function() {
                const selectedType = this.value;
                
                // Ẩn tất cả hướng dẫn
                phoneCardGuide.style.display = 'none';
                emailAccountGuide.style.display = 'none';
                defaultGuide.style.display = 'none';
                
                // Hiển thị hướng dẫn phù hợp
                switch(selectedType) {
                    case 'PHONE_CARD':
                        phoneCardGuide.style.display = 'block';
                        break;
                    case 'EMAIL_ACCOUNT':
                        emailAccountGuide.style.display = 'block';
                        break;
                    default:
                        defaultGuide.style.display = 'block';
                        break;
                }
            });
        }
    });
    
    // Excel Preview Functionality
    document.getElementById('excelFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file && file.name.toLowerCase().endsWith('.xlsx')) {
            previewExcelFile(file);
        }
    });
    
    function previewExcelFile(file) {
        const formData = new FormData();
        formData.append('excelFile', file);
        formData.append('productId', 0); // Temporary ID for preview
        
        // Show loading
        const previewDiv = document.getElementById('excelPreview');
        previewDiv.style.display = 'block';
        previewDiv.innerHTML = `
            <div class="card">
                <div class="card-body text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Đang xử lý file Excel...</p>
                </div>
            </div>
        `;
        
        fetch('/itp/shop/previewExcel', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showPreviewData(data);
            } else {
                showPreviewError(data.message || 'Lỗi khi xử lý file Excel');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showPreviewError('Có lỗi xảy ra khi xử lý file Excel!');
        });
    }
    
    function showPreviewData(data) {
        const previewDiv = document.getElementById('excelPreview');
        
        // Stats
        const statsHtml = `
            <div class="col-md-3">
                <div class="card text-center border-primary">
                    <div class="card-body">
                        <h5 class="text-primary">Tổng dòng</h5>
                        <h3 class="mb-0">${data.totalRows}</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-success">
                    <div class="card-body">
                        <h5 class="text-success">Hợp lệ</h5>
                        <h3 class="mb-0">${data.importedCount}</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-warning">
                    <div class="card-body">
                        <h5 class="text-warning">Cảnh báo</h5>
                        <h3 class="mb-0">${data.warnings.length}</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-danger">
                    <div class="card-body">
                        <h5 class="text-danger">Lỗi</h5>
                        <h3 class="mb-0">${data.errors.length}</h3>
                    </div>
                </div>
            </div>
        `;
        
        // Table
        let tableHtml = `
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>STT</th>
                        <th>Serial Code</th>
                        <th>Secret Code</th>
                        <th>Quantity</th>
                        <th>Face Value</th>
                        <th>Information</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        data.serials.forEach((serial, index) => {
            tableHtml += `
                <tr>
                    <td>${index + 1}</td>
                    <td><code>${serial.serialCode}</code></td>
                    <td><code>${serial.secretCode}</code></td>
                    <td><span class="badge bg-primary">${serial.quantity}</span></td>
                    <td><strong>${serial.faceValue.toLocaleString()} ₫</strong></td>
                    <td>${serial.information}</td>
                </tr>
            `;
        });
        
        tableHtml += '</tbody></table>';
        
        // Errors
        let errorsHtml = '';
        if (data.errors.length > 0) {
            errorsHtml += `
                <div class="alert alert-danger">
                    <h6><strong>Lỗi (${data.errors.length}):</strong></h6>
                    <ul class="mb-0">
                        ${data.errors.map(error => `<li>${error}</li>`).join('')}
                    </ul>
                </div>
            `;
        }
        
        if (data.warnings.length > 0) {
            errorsHtml += `
                <div class="alert alert-warning">
                    <h6><strong>Cảnh báo (${data.warnings.length}):</strong></h6>
                    <ul class="mb-0">
                        ${data.warnings.map(warning => `<li>${warning}</li>`).join('')}
                    </ul>
                </div>
            `;
        }
        
        previewDiv.innerHTML = `
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">Preview dữ liệu Excel - ${data.jsonFileName}</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        ${statsHtml}
                    </div>
                    <div class="table-responsive">
                        ${tableHtml}
                    </div>
                    ${errorsHtml}
                </div>
            </div>
        `;
    }
    
    function showPreviewError(message) {
        const previewDiv = document.getElementById('excelPreview');
        previewDiv.innerHTML = `
            <div class="card">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">Lỗi xử lý file Excel</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-danger">
                        <strong>Lỗi:</strong> ${message}
                    </div>
                </div>
            </div>
        `;
    }
</script>

</body>
</html>
