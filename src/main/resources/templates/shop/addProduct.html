<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head th:replace="~{Included/ShopHeader :: shopHead}">
    <link rel="stylesheet" th:href="@{/assets/css/shop/addProduct.css}">
</head>
<body style="margin:0;padding-top:56px;overflow-x:hidden;">
<div th:replace="~{Included/ShopHeader :: shopHeader}"></div>

<div class="container-fluid p-0">
    <!-- Sidebar Fixed -->
    <div style="position:fixed;top:56px;bottom:0;left:0;width:70px;z-index:1000;">
        <aside th:replace="~{Included/ShopSidebar :: sidebar}"></aside>
    </div>

    <!-- Main Content -->
    <div style="margin-left:85px;padding:1rem;min-height:calc(100vh - 56px);background:#f8f9fa;max-width:calc(100% - 85px);">
            <div class="d-flex align-items-center justify-content-between mb-3">
                <h4 class="mb-0">Thêm sản phẩm</h4>
                <a th:href="@{/shop/dashboard}" class="btn btn-outline-secondary btn-sm">← Dashboard</a>
            </div>

            <form th:action="@{/shop/addProduct}" th:object="${form}" method="post" enctype="multipart/form-data"
                  class="row g-3">

                    <div class="col-md-8">
                        <label class="form-label">Tên sản phẩm</label>
                        <input th:field="*{productName}" class="form-control" placeholder="Nhập tên..." required/>
                    </div>

                    <div class="col-md-4">
                    <label class="form-label">Giá <span class="text-danger">*</span></label>
                    <input th:field="*{price}" id="priceInput" type="number" min="0" step="0.01" class="form-control"
                           placeholder="0.00" required/>
                    <small class="text-muted">Giá này sẽ được tự động điền khi chọn mệnh giá</small>
                    </div>

                    <div class="col-md-6" th:if="${categories != null}">
                    <label class="form-label">Phân loại sản phẩm</label>
                    <select th:field="*{categoryId}" id="categoryId" class="form-select" onchange="updateProductTypeOptions()">
                        <option value="">-- Chọn phân loại (tùy chọn) --</option>
                        <option th:each="c : ${categories}" th:value="${c.id}"
                                th:text="${@shopController.getCategoryDisplayName(c.categoryName)}">Cat
                        </option>
                        </select>
                    </div>
                    <input th:if="${categories == null}" type="hidden" th:field="*{categoryId}"/>

                <div class="col-md-6">
                    <label class="form-label">Kiểu sản phẩm <span class="text-danger">*</span></label>
                    <select th:field="*{productType}" id="productTypeSelect" class="form-select" required
                            onchange="updateProductTypeGuide()">
                        <option value="">-- Chọn kiểu sản phẩm --</option>
                        <!-- Options will be populated dynamically based on category selection -->
                    </select>
                </div>

                <div class="col-md-6" id="faceValueSection" style="display: none;">
                    <label class="form-label">Mệnh giá <span class="text-danger">*</span></label>
                    <select id="faceValueSelect" name="faceValue" class="form-select"
                            onchange="updatePriceFromFaceValue()">
                        <option value="">-- Chọn mệnh giá --</option>
                        <option value="10000">10,000 ₫</option>
                        <option value="20000">20,000 ₫</option>
                        <option value="50000">50,000 ₫</option>
                        <option value="100000">100,000 ₫</option>
                        <option value="200000">200,000 ₫</option>
                        <option value="500000">500,000 ₫</option>
                        <option value="custom">Tùy chỉnh</option>
                    </select>
                </div>

                <!-- Business Fields -->
                <div class="col-md-6">
                    <label class="form-label">Nhà cung cấp</label>
                    <input name="supplier" type="text" class="form-control" placeholder="Tên nhà cung cấp"/>
                    <small class="text-muted">Tên công ty/nhà cung cấp sản phẩm</small>
                    </div>

                    <div class="col-md-6">
                    <label class="form-label">Phí sàn (%)</label>
                    <input name="platformFee" type="number" min="0" max="50" step="0.1" class="form-control"
                           placeholder="0" value="0" id="platformFeeInput" readonly/>
                    <small class="text-muted">Phí sàn tự động theo loại sản phẩm</small>
                    <div id="platformFeeInfo" class="mt-1"></div>
                </div>

                <div class="col-md-12">
                    <label class="form-label">Mô tả ngắn</label>
                    <textarea th:field="*{description}" class="form-control" rows="2"
                              placeholder="Mô tả ngắn gọn về sản phẩm"></textarea>
                </div>

                <div class="col-md-12">
                    <label class="form-label">Mô tả chi tiết</label>
                    <textarea th:field="*{detailedDescription}" class="form-control" rows="4"
                              placeholder="Mô tả chi tiết về sản phẩm, tính năng, cách sử dụng..."></textarea>
                </div>

                <div class="col-md-12">
                    <label class="form-label">Ảnh sản phẩm</label>
                    <input type="file" class="form-control" accept="image/*" id="imageFile" onchange="uploadImageNow(this)"/>
                    <input type="hidden" th:field="*{img}" id="imagePathInput"/>
                    <small class="text-muted">
                        <span id="uploadStatus"></span>
                    </small>
                    
                    <!-- Preview Container -->
                    <div id="imagePreviewBox" style="display:none;" class="mt-2">
                        <img id="imagePreviewImg" src="" style="max-height:150px;" class="img-thumbnail"/>
                        <button type="button" class="btn btn-sm btn-danger ms-2" onclick="removeImage()">Xóa</button>
                    </div>
                </div>

                <div class="col-md-12">
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">Tạo sản phẩm</button>
                        <a th:href="@{/shop/dashboard}" class="btn btn-secondary">Hủy</a>
                    </div>
                </div>
            </form>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
// AddProduct specific JavaScript functions

// Platform fee configuration by product type (Fixed rates)
const platformFeeConfig = {
    // Telecom cards - Lower fee (2-5%)
    'VIETTEL': { fee: 3, description: 'Thẻ điện thoại - Phí thấp' },
    'MOBIFONE': { fee: 3, description: 'Thẻ điện thoại - Phí thấp' },
    'VINAPHONE': { fee: 3, description: 'Thẻ điện thoại - Phí thấp' },
    'VIETTEL_DATA': { fee: 3, description: 'Gói data - Phí thấp' },
    'MOBIFONE_DATA': { fee: 3, description: 'Gói data - Phí thấp' },
    'VINAPHONE_DATA': { fee: 3, description: 'Gói data - Phí thấp' },
    
    // Digital accounts - Medium fee (5-10%)
    'EMAIL': { fee: 7, description: 'Tài khoản email - Phí trung bình' },
    'SOCIAL': { fee: 7, description: 'Social media - Phí trung bình' },
    'STREAMING': { fee: 7, description: 'Streaming - Phí trung bình' },
    'APP': { fee: 7, description: 'Ứng dụng - Phí trung bình' },
    
    // Gift cards - Medium fee (5-12%)
    'GIFT': { fee: 8, description: 'Thẻ quà tặng - Phí trung bình' },
    'VOUCHER': { fee: 8, description: 'Voucher - Phí trung bình' },
    'COUPON': { fee: 8, description: 'Coupon - Phí trung bình' },
    'PROMO': { fee: 8, description: 'Mã khuyến mãi - Phí trung bình' },
    
    // Software licenses - Higher fee (8-15%)
    'SOFTWARE': { fee: 12, description: 'Key phần mềm - Phí cao' },
    'LICENSE': { fee: 12, description: 'License key - Phí cao' },
    'ACTIVATION': { fee: 12, description: 'Mã kích hoạt - Phí cao' },
    'SUBSCRIPTION': { fee: 12, description: 'Subscription - Phí cao' },
    
    // Gaming - Variable fee (5-20%)
    'GAME_ACC': { fee: 10, description: 'Tài khoản game - Phí biến động' },
    'GAME_ITEM': { fee: 10, description: 'Item game - Phí biến động' },
    'GAME_CURRENCY': { fee: 10, description: 'Tiền tệ game - Phí biến động' },
    'GAME_CODE': { fee: 10, description: 'Gift code game - Phí biến động' },
    
    // Other - Default fee (5-10%)
    'OTHER': { fee: 7, description: 'Khác - Phí mặc định' }
};

// Category to ProductType mapping (Categories in English, ProductTypes in Vietnamese)
const categoryProductTypeMap = {
    // TELECOM (Viễn thông)
    'TELECOM': [
        { value: 'VIETTEL', text: 'Thẻ Viettel' },
        { value: 'MOBIFONE', text: 'Thẻ Mobifone' },
        { value: 'VINAPHONE', text: 'Thẻ Vinaphone' },
        { value: 'VIETTEL_DATA', text: 'Gói data Viettel' },
        { value: 'MOBIFONE_DATA', text: 'Gói data Mobifone' },
        { value: 'VINAPHONE_DATA', text: 'Gói data Vinaphone' }
    ],
    // DIGITAL_ACCOUNTS (Tài khoản số)
    'DIGITAL_ACCOUNTS': [
        { value: 'EMAIL', text: 'Tài khoản email' },
        { value: 'SOCIAL', text: 'Tài khoản social media' },
        { value: 'STREAMING', text: 'Tài khoản streaming' },
        { value: 'APP', text: 'Tài khoản ứng dụng' }
    ],
    // GIFTS_VOUCHERS (Quà tặng & Voucher)
    'GIFTS_VOUCHERS': [
        { value: 'GIFT', text: 'Thẻ quà tặng' },
        { value: 'VOUCHER', text: 'Voucher' },
        { value: 'COUPON', text: 'Coupon' },
        { value: 'PROMO', text: 'Mã khuyến mãi' }
    ],
    // SOFTWARE_LICENSES (Phần mềm & License)
    'SOFTWARE_LICENSES': [
        { value: 'SOFTWARE', text: 'Key phần mềm' },
        { value: 'LICENSE', text: 'License key' },
        { value: 'ACTIVATION', text: 'Mã kích hoạt' },
        { value: 'SUBSCRIPTION', text: 'Subscription' }
    ],
    // GAMING (Gaming)
    'GAMING': [
        { value: 'GAME_ACC', text: 'Tài khoản game' },
        { value: 'GAME_ITEM', text: 'Item game' },
        { value: 'GAME_CURRENCY', text: 'Tiền tệ game' },
        { value: 'GAME_CODE', text: 'Gift code game' }
    ],
    // OTHER (Khác)
    'OTHER': [
        { value: 'OTHER', text: 'Khác' }
    ]
};

// Handle category selection change
function updateProductTypeOptions() {
    const categorySelect = document.getElementById('categoryId');
    const productTypeSelect = document.getElementById('productTypeSelect');
    
    if (!categorySelect || !productTypeSelect) {
        return;
    }
    
    const selectedIndex = categorySelect.selectedIndex;
    const selectedCategoryText = categorySelect.options[selectedIndex].text;
    const selectedCategoryValue = categorySelect.options[selectedIndex].value;
    
    // Debug logging
    console.log('=== Category Selection Debug ===');
    console.log('Selected Index:', selectedIndex);
    console.log('Selected Text:', selectedCategoryText);
    console.log('Selected Value:', selectedCategoryValue);
    
    // Clear existing options except the first one
    productTypeSelect.innerHTML = '<option value="">-- Chọn kiểu sản phẩm --</option>';
    
    // If no category selected, return
    if (selectedIndex === 0 || !selectedCategoryValue) {
        return;
    }
    
    // Map Vietnamese category names (from database) to internal English keys for product type mapping
    // Database only has Vietnamese: Thẻ điện thoại, Tài khoản số, Phần mềm, Khác
    const displayNameToCategoryMap = {
        'Thẻ điện thoại': 'TELECOM',
        'Tài khoản số': 'DIGITAL_ACCOUNTS',
        'Phần mềm': 'SOFTWARE_LICENSES',
        'Khác': 'OTHER'
    };
    
    // Get English category name from Vietnamese display name
    const englishCategoryName = displayNameToCategoryMap[selectedCategoryText];
    
    console.log('Mapped English Category:', englishCategoryName);
    console.log('Available Product Types:', englishCategoryName ? categoryProductTypeMap[englishCategoryName] : 'NOT FOUND');
    
    // Add options based on selected category
    if (englishCategoryName && categoryProductTypeMap[englishCategoryName]) {
        categoryProductTypeMap[englishCategoryName].forEach(option => {
            const optionElement = document.createElement('option');
            optionElement.value = option.value;
            optionElement.textContent = option.text;
            productTypeSelect.appendChild(optionElement);
        });
    }
    
    // Reset product type guide
    updateProductTypeGuide();
}

// Handle product type selection
function updateProductTypeGuide() {
    const productType = document.querySelector('select[name="productType"]').value;
    const faceValueSection = document.getElementById('faceValueSection');
    const faceValueSelect = document.getElementById('faceValueSelect');
    const priceInput = document.getElementById('priceInput');
    const platformFeeInput = document.getElementById('platformFeeInput');
    const platformFeeInfo = document.getElementById('platformFeeInfo');
    
    // Hide all guides first
    faceValueSection.style.display = 'none';
    
    // Clear platform fee info
    if (platformFeeInfo) {
        platformFeeInfo.innerHTML = '';
    }
    
    // Clear platform fee input
    if (platformFeeInput) {
        platformFeeInput.value = '';
    }
    
    if (!productType) {
        return;
    }
    
    // Show face value section for telecom products
    if (['VIETTEL', 'MOBIFONE', 'VINAPHONE', 'VIETTEL_DATA', 'MOBIFONE_DATA', 'VINAPHONE_DATA'].includes(productType)) {
        faceValueSection.style.display = 'block';
    }
    
    // Update platform fee
    if (platformFeeConfig[productType]) {
        const config = platformFeeConfig[productType];
        if (platformFeeInput) {
            platformFeeInput.value = config.fee;
        }
        if (platformFeeInfo) {
            platformFeeInfo.innerHTML = `<small class="text-info">${config.description}</small>`;
        }
    }
}

// Initialize event listener for category change
document.addEventListener('DOMContentLoaded', function() {
    // Wait a bit for DOM to be fully ready
    setTimeout(function() {
        const categorySelect = document.getElementById('categoryId');
        const productTypeSelect = document.getElementById('productTypeSelect');
        
        if (categorySelect) {
            categorySelect.addEventListener('change', function() {
                updateProductTypeOptions();
            });
            
            // Also try onchange attribute as backup
            categorySelect.setAttribute('onchange', 'updateProductTypeOptions()');
            
            // Initial call
            updateProductTypeOptions();
        }
        
    }, 100); // Wait 100ms
    
    // Initialize platform fee to empty state
    const platformFeeInput = document.getElementById('platformFeeInput');
    const platformFeeInfo = document.getElementById('platformFeeInfo');
    if (platformFeeInput && platformFeeInfo) {
        platformFeeInput.value = '';
        platformFeeInfo.innerHTML = '';
    }
});


// Update price from face value selection
function updatePriceFromFaceValue() {
    const faceValueSelect = document.getElementById('faceValueSelect');
    const priceInput = document.getElementById('priceInput');
    
    if (!faceValueSelect || !priceInput) {
        return;
    }
    
    const selectedValue = faceValueSelect.value;
    
    if (selectedValue === 'custom') {
        // Show custom price input
        priceInput.readOnly = false;
        priceInput.placeholder = 'Nhập giá tùy chỉnh';
        priceInput.value = '';
    } else if (selectedValue && selectedValue !== '') {
        // Set price from face value
        priceInput.value = selectedValue;
        priceInput.readOnly = false; // Allow editing
    } else {
        // Clear price
        priceInput.value = '';
        priceInput.readOnly = false;
        priceInput.placeholder = 'Nhập giá sản phẩm';
    }
}

// Upload ảnh ngay lập tức khi chọn file - NHANH
function uploadImageNow(input) {
    const file = input.files[0];
    if (!file) return;
    
    const statusEl = document.getElementById('uploadStatus');
    const previewBox = document.getElementById('imagePreviewBox');
    const previewImg = document.getElementById('imagePreviewImg');
    const imagePathInput = document.getElementById('imagePathInput');
    
    // Hiển thị đang upload
    statusEl.innerHTML = '<i class="fas fa-spinner fa-spin text-primary"></i> Đang upload ảnh...';
    previewBox.style.display = 'none';
    
    // Upload bằng AJAX
    const formData = new FormData();
    formData.append('file', file);
    
    fetch('/itp/shop/uploadImage', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Upload thành công
            const imagePath = data.imagePath;
            imagePathInput.value = imagePath; // Lưu path vào hidden input
            previewImg.src = imagePath; // Hiển thị preview
            previewBox.style.display = 'block';
            statusEl.innerHTML = '<i class="fas fa-check-circle text-success"></i> Upload thành công!';
            console.log(' Image uploaded:', imagePath);
        } else {
            statusEl.innerHTML = '<i class="fas fa-times-circle text-danger"></i> ' + data.message;
        }
    })
    .catch(error => {
        console.error('Upload error:', error);
        statusEl.innerHTML = '<i class="fas fa-times-circle text-danger"></i> Lỗi upload ảnh';
    });
}

// Xóa ảnh
function removeImage() {
    document.getElementById('imageFile').value = '';
    document.getElementById('imagePathInput').value = '';
    document.getElementById('imagePreviewBox').style.display = 'none';
    document.getElementById('uploadStatus').innerHTML = '';
}

// Submit form directly without confirmation
function confirmSubmit() {
    const productName = document.querySelector('input[name="productName"]');
    
    if (!productName) {
        alert('Có lỗi xảy ra khi lấy thông tin form');
        return false;
    }
    
    // Show loading state on submit button
    const submitButton = document.querySelector('button[type="submit"]');
    if (submitButton) {
        submitButton.classList.add('btn-loading');
        submitButton.disabled = true;
        submitButton.textContent = 'Đang tạo...';
        
        // Add timeout to prevent infinite loading
        setTimeout(() => {
            if (submitButton.disabled) {
                console.warn('Form submission timeout - re-enabling button');
                submitButton.disabled = false;
                submitButton.textContent = 'Tạo sản phẩm';
                submitButton.classList.remove('btn-loading');
                alert('Form submission timeout. Vui lòng thử lại.');
            }
        }, 30000); // 30 seconds timeout
    }
    return true;
}
</script>
</body>
</html>
