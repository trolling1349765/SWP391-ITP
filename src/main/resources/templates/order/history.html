<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta charset="UTF-8"/>
    <title>L·ªãch s·ª≠ mua h√†ng | ITP System</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <style>
        body { background-color: #f8fafc; font-family: 'Inter', sans-serif; }
        .history-container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .order-card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .status-badge { padding: 6px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-completed { background: #d4edda; color: #155724; }
        .status-failed { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
<!-- Header -->
<div th:replace="~{/Included/Header :: header}"></div>

<div class="history-container">
    <h2 class="mb-4">ƒê∆°n h√†ng ƒë√£ mua</h2>

    <!-- Success/Error Messages -->
    <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
        <span th:text="${success}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <span th:text="${error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <!-- Search/Filter Section -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="get" th:action="@{/orders/history}" class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Nh·∫≠p m√£ ƒë∆°n h√†ng</label>
                    <input type="text" name="orderCode" class="form-control" placeholder="Nh·∫≠p m√£ ƒë∆°n h√†ng">
                </div>
                <div class="col-md-6 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary">
                        T√¨m ƒë∆°n h√†ng
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Important Notes -->
    <div class="alert alert-warning">
        <h6 class="alert-heading">Xin l∆∞u √Ω</h6>
        <ul class="mb-0">
            <li class="text-danger">B·∫•m v√†o <strong>M√É ƒê∆†N H√ÄNG</strong> ƒë·ªÉ xem chi ti·∫øt s·∫£n ph·∫©m ƒë√£ mua!</li>
            <li>Nh·ªØng t√≠nh nƒÉng v√† ch·∫•t l∆∞·ª£ng s·∫£n ph·∫©m ch√∫ng t√¥i kh√¥ng th·ªÉ n√†o r√µ b·∫±ng ng∆∞·ªùi b√°n h√†ng, n·∫øu c√≥ b·∫•t c·ª© th·∫Øc m·∫Øc g√¨ v·ªÅ m·∫∑t h√†ng, xin li√™n h·ªá ch·ªß shop ƒë·ªÉ ƒë∆∞·ª£c gi·∫£i quy·∫øt ho·∫∑c b·∫£o h√†nh.</li>
            <li>Trong tr∆∞·ªùng h·ª£p ch·ªß shop kh√¥ng gi·∫£i quy·∫øt ho·∫∑c gi·∫£i quy·∫øt kh√¥ng th·ªèa ƒë√°ng, h√£y b·∫•m v√†o "Khi·∫øu n·∫°i ƒë∆°n h√†ng", ƒë·ªÉ b√™n m√¨nh c√≥ th·ªÉ gi·ªØ ti·ªÅn ƒë∆°n h√†ng ƒë√≥ (l√¢u h∆°n 3 ng√†y) trong l√∫c b·∫°n ƒë·ª£i ph·∫£n h·ªìi t·ª´ ng∆∞·ªùi b√°n.</li>
            <li>B√™n m√¨nh ch·ªâ gi·ªØ ti·ªÅn 3 ng√†y, trong tr∆∞·ªùng h·ª£p ƒë∆°n h√†ng kh√¥ng c√≥ khi·∫øu n·∫°i g√¨, ti·ªÅn s·∫Ω ƒë∆∞·ª£c chuy·ªÉn cho ng∆∞·ªùi b√°n, v√¨ v·∫≠y xin h√£y <strong>KI·ªÇM TRA K·ª∏ S·∫¢N PH·∫®M</strong> sau khi mua.</li>
        </ul>
    </div>

    <!-- Orders Table -->
    <div class="card">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Thao t√°c</th>
                            <th>M√£ ƒë∆°n h√†ng</th>
                            <th>Ng√†y mua</th>
                            <th>Gian h√†ng</th>
                            <th>M·∫∑t h√†ng</th>
                            <th>Ng∆∞·ªùi b√°n</th>
                            <th>S·ªë l∆∞·ª£ng</th>
                            <th>ƒê∆°n gi√°</th>
                            <th>T·ªïng ti·ªÅn</th>
                            <th>Tr·∫°ng th√°i</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:if="${orders == null or orders.isEmpty()}">
                            <td colspan="10" class="text-center py-5 text-muted">
                                <p>B·∫°n ch∆∞a c√≥ ƒë∆°n h√†ng n√†o</p>
                                <a th:href="@{/products}" class="btn btn-primary">Mua s·∫Øm ngay</a>
                            </td>
                        </tr>
                        <tr th:each="order : ${orders}" th:attr="data-order-id=${order.id}">
                            <td>
                                <a th:href="@{'/orders/detail/' + ${order.id}}" class="btn btn-sm btn-outline-primary" title="Xem chi ti·∫øt">
                                    Xem
                                </a>
                            </td>
                            <td>
                                <a th:href="@{'/orders/detail/' + ${order.id}}" 
                                   class="text-decoration-none fw-bold" 
                                   th:text="${order.orderCode}">ORD123456</a>
                            </td>
                            <td>
                                <div th:text="${order.createAt != null ? #temporals.format(order.createAt, 'dd/MM/yyyy') : 'N/A'}">03/11/2025</div>
                                <small class="text-muted" th:if="${order.createAt != null}" 
                                       th:text="${#temporals.format(order.createAt, 'HH:mm')}">16:58</small>
                            </td>
                            <td>
                                <span th:if="${order.product != null and order.product.shop != null}" 
                                      th:text="${order.product.shop.shopName}">Shop Name</span>
                                <span th:if="${order.product == null or order.product.shop == null}">N/A</span>
                            </td>
                            <td>
                                <span th:if="${order.product != null}" th:text="${order.product.productName}">Product Name</span>
                                <span th:if="${order.product == null}" class="text-muted">ƒê√£ x√≥a</span>
                            </td>
                            <td>
                                <span th:if="${order.product != null and order.product.shop != null}" 
                                      th:text="${order.product.shop.shopName}">Shop Name</span>
                                <span th:if="${order.product == null or order.product.shop == null}" class="text-muted">N/A</span>
                            </td>
                            <td th:text="${order.quantity}">1</td>
                            <td th:text="${#numbers.formatDecimal(order.unitPrice, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'">60.000 ‚Ç´</td>
                            <td class="fw-bold" th:text="${#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'">60.000 ‚Ç´</td>
                            <td>
                                <span th:if="${order.status == 'PENDING'}" 
                                      class="status-badge status-pending">ƒêang gi·ªØ ti·ªÅn</span>
                                <span th:if="${order.status == 'COMPLETED'}" 
                                      class="status-badge status-completed">ƒê√£ thanh to√°n</span>
                                <span th:if="${order.status == 'FAILED'}" 
                                      class="status-badge status-failed">Th·∫•t b·∫°i</span>
                                <span th:if="${order.status != 'PENDING' and order.status != 'COMPLETED' and order.status != 'FAILED'}" 
                                      class="status-badge status-pending" th:text="${order.status}">Status</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Polling ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i real-time
    // Order s·∫Ω chuy·ªÉn t·ª´ PENDING ‚Üí COMPLETED sau 35 gi√¢y (15s x·ª≠ l√Ω + 20s hold ti·ªÅn)
    let hasPendingOrders = false;
    const pendingOrderRows = [];
    
    // T√¨m t·∫•t c·∫£ c√°c ƒë∆°n h√†ng c√≥ status PENDING
    document.querySelectorAll('tbody tr[data-order-id]').forEach(function(row) {
        const orderId = row.getAttribute('data-order-id');
        if (orderId) {
            // T√¨m status cell - c√≥ th·ªÉ l√† .status-pending ho·∫∑c b·∫•t k·ª≥ status badge n√†o
            const statusCell = row.querySelector('td:last-child .status-badge');
            if (statusCell) {
                const statusText = statusCell.textContent.trim();
                // Ki·ªÉm tra n·∫øu l√† PENDING status
                if (statusText.includes('ƒêang gi·ªØ ti·ªÅn') || statusText.includes('ƒêang hold ti·ªÅn') || statusCell.classList.contains('status-pending')) {
                    hasPendingOrders = true;
                    pendingOrderRows.push({
                        row: row,
                        orderId: orderId,
                        statusCell: statusCell,
                        statusText: statusText
                    });
                    console.log('‚úÖ Ph√°t hi·ªán ƒë∆°n h√†ng PENDING: Order ID = ' + orderId);
                }
            }
        }
    });
    
    if (hasPendingOrders) {
        console.log(' Ph√°t hi·ªán ' + pendingOrderRows.length + ' ƒë∆°n h√†ng ƒëang hold ti·ªÅn. B·∫Øt ƒë·∫ßu polling ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i real-time...');
        console.log('‚è± Th·ªùi gian x·ª≠ l√Ω: 15s (queue, DB) + 20s (hold ti·ªÅn) = 35s t·ªïng c·ªông');
        
        // Polling m·ªói 2 gi√¢y ƒë·ªÉ ki·ªÉm tra tr·∫°ng th√°i
        let pollCount = 0;
        const maxPolls = 20; // 20 l·∫ßn * 2 gi√¢y = 40 gi√¢y (ƒë·ªß th·ªùi gian cho 35s + buffer)
        const startTime = Date.now();
        
        const pollInterval = setInterval(function() {
            pollCount++;
            const elapsedSeconds = Math.floor((Date.now() - startTime) / 1000);
            console.log('üì° Polling l·∫ßn ' + pollCount + ' (ƒë√£ qua ' + elapsedSeconds + 's) - Ki·ªÉm tra tr·∫°ng th√°i ƒë∆°n h√†ng...');
            
            // G·ª≠i request ƒë·ªÉ l·∫•y tr·∫°ng th√°i m·ªõi nh·∫•t
            fetch('/itp/orders/api/status', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'same-origin' // ƒê·∫£m b·∫£o g·ª≠i session cookie
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('HTTP error! status: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                console.log(' Response t·ª´ API:', data);
                if (data && data.success && data.orders) {
                    let allCompleted = true;
                    let updatedCount = 0;
                    
                    pendingOrderRows.forEach(function(item) {
                        const orderStatus = data.orders[item.orderId];
                        console.log('  - Order ' + item.orderId + ': status = ' + orderStatus);
                        
                        if (orderStatus) {
                            if (orderStatus === 'COMPLETED') {
                                // C·∫≠p nh·∫≠t tr·∫°ng th√°i trong UI
                                item.statusCell.className = 'status-badge status-completed';
                                item.statusCell.textContent = 'ƒê√£ thanh to√°n';
                                console.log(' Order ' + item.orderId + ' ƒë√£ chuy·ªÉn sang tr·∫°ng th√°i: ƒê√£ thanh to√°n');
                                updatedCount++;
                            } else if (orderStatus === 'PENDING') {
                                // V·∫´n ƒëang x·ª≠ l√Ω
                                allCompleted = false;
                                console.log(' Order ' + item.orderId + ' v·∫´n ƒëang x·ª≠ l√Ω (PENDING)...');
                            } else {
                                // Status kh√°c (FAILED, etc.)
                                allCompleted = false;
                                console.log('Ô∏è Order ' + item.orderId + ' c√≥ status: ' + orderStatus);
                            }
                        } else {
                            allCompleted = false;
                            console.log(' Kh√¥ng t√¨m th·∫•y status cho Order ' + item.orderId);
                        }
                    });
                    
                    if (updatedCount > 0) {
                        console.log(' ƒê√£ c·∫≠p nh·∫≠t ' + updatedCount + ' ƒë∆°n h√†ng sang tr·∫°ng th√°i COMPLETED');
                    }
                    
                    // N·∫øu t·∫•t c·∫£ ƒë√£ ho√†n th√†nh, d·ª´ng polling
                    if (allCompleted) {
                        console.log(' T·∫•t c·∫£ ƒë∆°n h√†ng ƒë√£ ho√†n th√†nh. D·ª´ng polling.');
                        clearInterval(pollInterval);
                    }
                } else {
                    console.warn('‚ö† API response kh√¥ng h·ª£p l·ªá:', data);
                }
            })
            .catch(error => {
                console.error(' L·ªói khi polling tr·∫°ng th√°i:', error);
            });
            
            // D·ª´ng polling sau maxPolls l·∫ßn
            if (pollCount >= maxPolls) {
                console.log(' ƒê√£ polling ƒë·ªß s·ªë l·∫ßn (' + maxPolls + '). Reload trang ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i cu·ªëi c√πng...');
                clearInterval(pollInterval);
                setTimeout(function() {
                    window.location.reload();
                }, 1000);
            }
        }, 2000); // Poll m·ªói 2 gi√¢y
        
        // Fallback: Auto-refresh sau 40 gi√¢y ƒë·ªÉ ƒë·∫£m b·∫£o c·∫≠p nh·∫≠t
        setTimeout(function() {
            if (pollInterval) {
                clearInterval(pollInterval);
            }
            console.log(' Auto-refresh trang sau 40 gi√¢y ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i cu·ªëi c√πng...');
            window.location.reload();
        }, 40000); // 40 gi√¢y (35s + 5s buffer)
    } else {
        console.log(' Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o ƒëang ·ªü tr·∫°ng th√°i PENDING. Kh√¥ng c·∫ßn polling.');
    }
</script>
</body>
</html>

