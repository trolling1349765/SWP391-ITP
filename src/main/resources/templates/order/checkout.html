<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta charset="UTF-8"/>
    <title>Thanh to√°n | ITP System</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" th:href="@{/assets/css/order/checkout.css}">
</head>
<body>
<!-- Header -->
<div th:replace="~{/Included/Header :: header}"></div>

<div class="checkout-container">
    <h2 class="mb-4">Thanh to√°n</h2>

    <!-- Success/Error Messages -->
    <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
        <span th:text="${success}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <div class="d-flex align-items-start">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-exclamation-triangle-fill me-2 flex-shrink-0" viewBox="0 0 16 16" style="margin-top: 2px;">
                <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
            </svg>
            <div class="flex-grow-1">
                <div th:if="${refunded}" class="mb-2">
                    <strong class="text-success">‚úÖ Ti·ªÅn ƒë√£ ƒë∆∞·ª£c ho√†n l·∫°i v√†o t√†i kho·∫£n c·ªßa b·∫°n.</strong>
                </div>
                <strong class="d-block mb-2">‚ö†Ô∏è Kh√¥ng th·ªÉ ƒë·∫∑t h√†ng!</strong>
                <div th:utext="${#strings.replace(error, T(java.lang.System).lineSeparator(), '<br>')}"></div>
                <div th:if="${error != null and (#strings.contains(error, 'kh√¥ng ƒë·ªß ti·ªÅn') or #strings.contains(error, 'kh√¥ng ƒë·ªß') or #strings.contains(error, 'ƒë·ªß ti·ªÅn'))}" class="mt-3 p-3 bg-light rounded border">
                    <strong>üí° H∆∞·ªõng d·∫´n n·∫°p ti·ªÅn:</strong>
                    <ul class="mb-0 mt-2">
                        <li>Li√™n h·ªá admin ƒë·ªÉ ƒë∆∞·ª£c h·ªó tr·ª£ n·∫°p ti·ªÅn v√†o t√†i kho·∫£n</li>
                        <li>Ki·ªÉm tra s·ªë d∆∞ hi·ªán t·∫°i c·ªßa b·∫°n ·ªü g√≥c tr√™n b√™n ph·∫£i m√†n h√¨nh</li>
                        <li>Sau khi n·∫°p ti·ªÅn, quay l·∫°i trang n√†y ƒë·ªÉ ti·∫øp t·ª•c ƒë·∫∑t h√†ng</li>
                    </ul>
                </div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal fade" id="confirmPurchaseModal" tabindex="-1" aria-labelledby="confirmPurchaseModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmPurchaseModalLabel">X√°c nh·∫≠n ƒë·∫∑t h√†ng</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="fw-bold mb-3">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën mua s·∫£n ph·∫©m n√†y kh√¥ng?</p>
                    
                    <div class="border rounded p-3 mb-3" style="background-color: #f8f9fa;">
                        <div class="d-flex justify-content-between mb-2">
                            <span>S·∫£n ph·∫©m:</span>
                            <span class="fw-bold" th:text="${product.productName}">Product Name</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>S·ªë l∆∞·ª£ng:</span>
                            <span class="fw-bold" id="confirmQuantity">1</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>ƒê∆°n gi√°:</span>
                            <span class="fw-bold" id="confirmUnitPrice" th:text="${#numbers.formatDecimal(product.price, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'">0 ‚Ç´</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between">
                            <span class="fw-bold">T·ªïng thanh to√°n:</span>
                            <span class="fw-bold text-danger" id="confirmTotalAmount">0 ‚Ç´</span>
                        </div>
                        <div class="d-flex justify-content-between mt-2">
                            <span>S·ªë d∆∞ hi·ªán t·∫°i:</span>
                            <span class="fw-bold" id="confirmBalance" th:text="${#numbers.formatDecimal(balance, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'">0 ‚Ç´</span>
                        </div>
                        <div class="d-flex justify-content-between mt-2" id="confirmRemainingBalance" style="display: none;">
                            <span>S·ªë d∆∞ c√≤n l·∫°i:</span>
                            <span class="fw-bold text-success" id="confirmRemainingAmount">0 ‚Ç´</span>
                        </div>
                    </div>
                    
                    <div class="alert alert-warning mb-0">
                        <small>Sau khi x√°c nh·∫≠n, ti·ªÅn s·∫Ω ƒë∆∞·ª£c tr·ª´ kh·ªèi t√†i kho·∫£n v√† ƒë∆°n h√†ng s·∫Ω ƒë∆∞·ª£c x·ª≠ l√Ω. Ti·ªÅn s·∫Ω ƒë∆∞·ª£c chuy·ªÉn cho ng∆∞·ªùi b√°n sau 20 gi√¢y.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="button" class="btn btn-primary" id="confirmPurchaseBtn">X√°c nh·∫≠n mua</button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Left Column: Product Info -->
        <div class="col-md-8">
            <!-- Product Card -->
            <div class="product-card">
                <h5 class="mb-3">Th√¥ng tin s·∫£n ph·∫©m</h5>
                
                <div class="row">
                    <div class="col-md-4">
                        <img th:if="${product.image}" 
                             th:src="@{${product.image}}" 
                             class="img-fluid rounded" 
                             alt="Product Image">
                        <div th:unless="${product.image}" class="alert alert-secondary">Ch∆∞a c√≥ ·∫£nh</div>
                    </div>
                    <div class="col-md-8">
                        <h4 th:text="${product.productName}">Product Name</h4>
                        <p class="text-muted mb-2">
                            <span th:if="${product.shop != null}" th:text="${'Shop: ' + product.shop.shopName}">Shop Name</span>
                        </p>
                        <div class="price-highlight mb-3">
                            <span th:text="${#numbers.formatDecimal(product.price, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'">0 ‚Ç´</span>
                        </div>
                        <div class="mb-2">
                            <span class="badge bg-success" th:if="${availableStock > 0}">C√≤n h√†ng</span>
                            <span class="badge bg-danger" th:if="${availableStock == 0}">H·∫øt h√†ng</span>
                            <span class="ms-2">T·ªìn kho: <strong th:text="${availableStock}">0</strong></span>
                        </div>
                    </div>
                </div>

                <!-- Quantity Selector -->
                <div class="mt-4 border-top pt-3">
                    <label class="form-label fw-bold">S·ªë l∆∞·ª£ng:</label>
                    <div class="quantity-selector">
                        <button type="button" onclick="decreaseQuantity()" class="btn btn-outline-secondary">-</button>
                        <input type="number" id="quantityInput" th:value="${quantity}" min="1" th:attr="max=${availableStock}" onchange="updateTotal()">
                        <button type="button" onclick="increaseQuantity()" class="btn btn-outline-secondary">+</button>
                    </div>
                    <small class="text-muted">T·ªìn kho: <span th:text="${availableStock}">0</span> s·∫£n ph·∫©m</small>
                </div>

                <!-- Message to Seller -->
                <div class="mt-4 border-top pt-3">
                    <label class="form-label fw-bold">L∆∞u √Ω cho Ng∆∞·ªùi b√°n:</label>
                    <textarea class="form-control" 
                              id="messageToSeller" 
                              name="messageToSeller" 
                              rows="3" 
                              placeholder="Nh·∫≠p l·ªùi nh·∫Øn cho ng∆∞·ªùi b√°n (kh√¥ng b·∫Øt bu·ªôc)..."></textarea>
                </div>
            </div>
        </div>

        <!-- Right Column: Order Summary -->
        <div class="col-md-4">
            <div class="summary-card">
                <h5 class="mb-3">ƒê∆°n h√†ng</h5>

                <!-- Balance Info -->
                <div class="balance-info">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="fw-bold">S·ªë d∆∞ hi·ªán t·∫°i:</span>
                        <span class="price-highlight" style="font-size: 1.2rem;" th:text="${#numbers.formatDecimal(balance, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'">0 ‚Ç´</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span>S·ªë ti·ªÅn c·∫ßn thanh to√°n:</span>
                        <span class="fw-bold" id="totalAmountDisplay" th:text="${#numbers.formatDecimal(totalAmount, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'">0 ‚Ç´</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-2" id="needTopUpSection" style="display: none;">
                        <span class="text-danger fw-bold">üí≥ C·∫ßn n·∫°p th√™m:</span>
                        <span class="text-danger fw-bold" id="needTopUpAmount">0 ‚Ç´</span>
                    </div>
                    <div class="alert alert-warning mt-2 mb-0" id="insufficientBalanceInfo" style="display: none;">
                        <small>
                            <strong>‚ö†Ô∏è L∆∞u √Ω:</strong> B·∫°n kh√¥ng ƒë·ªß ti·ªÅn ƒë·ªÉ thanh to√°n ƒë∆°n h√†ng n√†y. 
                            Vui l√≤ng n·∫°p ti·ªÅn v√†o t√†i kho·∫£n ho·∫∑c gi·∫£m s·ªë l∆∞·ª£ng s·∫£n ph·∫©m.
                        </small>
                    </div>
                </div>

                <!-- Order Summary -->
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-2">
                        <span>T·ªïng gi√° tr·ªã s·∫£n ph·∫©m:</span>
                        <span id="productTotal" th:text="${#numbers.formatDecimal(product.price, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'">0 ‚Ç´</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between">
                        <span class="fw-bold">T·ªïng thanh to√°n:</span>
                        <span class="price-highlight" id="finalTotal" th:text="${#numbers.formatDecimal(totalAmount, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'">0 ‚Ç´</span>
                    </div>
                </div>

                <!-- Submit Form -->
                <form th:action="@{/orders/checkout/submit}" method="post" id="checkoutForm">
                    <input type="hidden" name="productId" th:value="${product.id}">
                    <input type="hidden" name="quantity" id="formQuantity" th:value="${quantity}">
                    <input type="hidden" name="messageToSeller" id="formMessage">
                    
                    <button type="button" class="btn btn-primary w-100 btn-lg" id="submitBtn" onclick="confirmPurchase()">
                        ƒê·∫∑t h√†ng
                    </button>
                </form>

                <a th:href="@{/products}" class="btn btn-outline-secondary w-100 mt-2">
                    Ti·∫øp t·ª•c mua s·∫Øm
                </a>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/assets/js/order/checkout.js}"></script>
<script th:inline="javascript">
    /*<![CDATA[*/
    // Initialize checkout with server data
    const price = /*[[${product.price != null ? product.price.doubleValue() : 0}]]*/ 0;
    const stock = /*[[${availableStock != null ? availableStock : 0}]]*/ 0;
    const balance = /*[[${balance != null ? balance.doubleValue() : 0}]]*/ 0;
    
    initCheckout(price, stock, balance);
    /*]]>*/
</script>
</body>
</html>

