<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta charset="UTF-8"/>
    <title>Chi tiết đơn hàng | ITP System</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <style>
        body { background-color: #f8fafc; font-family: 'Inter', sans-serif; }
        .detail-container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .info-card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .status-badge { padding: 6px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-completed { background: #d4edda; color: #155724; }
        .status-failed { background: #f8d7da; color: #721c24; }
        .serial-code { font-family: monospace; background: #f8f9fa; padding: 8px 12px; border-radius: 6px; }
        .product-image-container { text-align: center; }
        .product-image-container img { box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    </style>
</head>
<body>
<!-- Header -->
<div th:replace="~{/Included/Header :: header}"></div>

<div class="detail-container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Chi tiết đơn hàng</h2>
        <a th:href="${backUrl != null ? backUrl : '/orders/history'}" class="btn btn-outline-secondary">
            Quay lại
        </a>
    </div>

    <!-- Order Info -->
    <div class="info-card">
        <h5 class="mb-3">Thông tin đơn hàng</h5>
        <div class="row g-3">
            <!-- Product Image (if available) -->
            <div class="col-12" th:if="${order.product != null and order.product.image != null and !#strings.isEmpty(order.product.image)}">
                <div class="product-image-container mb-3">
                    <img th:src="@{${order.product.image}}" 
                         th:alt="${order.product.productName}"
                         class="img-fluid rounded"
                         style="max-height: 300px; object-fit: cover;"
                         onerror="this.style.display='none'">
                </div>
            </div>
            
            <div class="col-md-6">
                <strong>Mã đơn hàng:</strong>
                <div class="serial-code" th:text="${order.orderCode}">ORD123456</div>
            </div>
            <div class="col-md-6">
                <strong>Trạng thái:</strong>
                <div>
                    <span th:if="${order.status == 'PENDING'}" class="status-badge status-pending">Đang giữ tiền</span>
                    <span th:if="${order.status == 'COMPLETED'}" class="status-badge status-completed">Đã thanh toán</span>
                    <span th:if="${order.status == 'FAILED'}" class="status-badge status-failed">Thất bại</span>
                </div>
            </div>
            <div class="col-md-6">
                <strong>Ngày mua:</strong>
                <div th:text="${order.createAt != null ? #temporals.format(order.createAt, 'dd/MM/yyyy HH:mm') : 'N/A'}">03/11/2025 16:58</div>
            </div>
            <div class="col-md-6">
                <strong>Gian hàng:</strong>
                <div th:if="${order.product != null and order.product.shop != null}" th:text="${order.product.shop.shopName}">Shop Name</div>
                <div th:if="${order.product == null or order.product.shop == null}" class="text-muted">N/A</div>
            </div>
            <!-- Thông tin người mua (chỉ hiển thị khi shop xem) -->
            <div class="col-md-6" th:if="${isSeller == true}">
                <strong>Người mua:</strong>
                <div th:if="${order.user != null}">
                    <div><strong>Tên:</strong> <span th:text="${order.user.fullName != null ? order.user.fullName : order.user.username}">Username</span></div>
                    <div><strong>Email:</strong> <span th:text="${order.user.email}">email@example.com</span></div>
                    <div th:if="${order.user.phone != null}"><strong>SĐT:</strong> <span th:text="${order.user.phone}">0123456789</span></div>
                </div>
                <div th:if="${order.user == null}" class="text-muted">N/A</div>
            </div>
            <div class="col-md-6">
                <strong>Sản phẩm:</strong>
                <div th:if="${order.product != null}" th:text="${order.product.productName}">Product Name</div>
                <div th:if="${order.product == null}" class="text-muted">Đã xóa</div>
            </div>
            <div class="col-md-6">
                <strong>Số lượng:</strong>
                <div th:text="${order.quantity}">1</div>
            </div>
            <div class="col-md-6">
                <strong>Đơn giá:</strong>
                <div th:text="${#numbers.formatDecimal(order.unitPrice, 0, 'COMMA', 0, 'POINT')} + ' ₫'">60.000 ₫</div>
            </div>
            <div class="col-md-6">
                <strong>Tổng tiền:</strong>
                <div class="fw-bold text-danger" style="font-size: 1.2rem;" th:text="${#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT')} + ' ₫'">60.000 ₫</div>
            </div>
            <div class="col-12" th:if="${order.messageToSeller != null and !#strings.isEmpty(order.messageToSeller)}">
                <strong>Lời nhắn cho người bán:</strong>
                <div class="border rounded p-2 bg-light" th:text="${order.messageToSeller}">Message</div>
            </div>
        </div>
    </div>

    <!-- Serial Codes -->
    <div class="info-card" th:if="${orderItems != null and !orderItems.isEmpty()}">
        <h5 class="mb-3">Mã sản phẩm đã mua</h5>
        <div class="alert alert-info" th:if="${isSeller != true}">
            Bạn đã mua <strong th:text="${order.quantity}">1</strong> sản phẩm. Dưới đây là các mã sản phẩm:
        </div>
        <div class="table-responsive">
            <table class="table table-bordered">
                <thead class="table-light">
                    <tr>
                        <th width="50">STT</th>
                        <th>Mã Sản Phẩm</th>
                        <th>Mật khẩu()</th>
                        <th>Giá</th>
                        <th>Thông tin</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="item, iterStat : ${orderItems}">
                        <td th:text="${iterStat.index + 1}">1</td>
                        <td>
                            <div class="serial-code" th:text="${item.serialCode}">SERIAL123</div>
                        </td>
                        <td>
                            <div class="serial-code" th:if="${item.secretCode != null and !#strings.isEmpty(item.secretCode)}" th:text="${item.secretCode}">SECRET456</div>
                            <span th:if="${item.secretCode == null or #strings.isEmpty(item.secretCode)}" class="text-muted">N/A</span>
                        </td>
                        <td th:text="${item.faceValue != null ? #numbers.formatDecimal(item.faceValue, 0, 'COMMA', 0, 'POINT') + ' ₫' : 'N/A'}">10.000 ₫</td>
                        <td th:text="${item.information != null ? item.information : 'N/A'}">Information</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="info-card" th:if="${orderItems == null or orderItems.isEmpty()}">
        <div class="alert alert-warning">
            Đơn hàng này chưa có mã sản phẩm. Vui lòng liên hệ hỗ trợ.
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

